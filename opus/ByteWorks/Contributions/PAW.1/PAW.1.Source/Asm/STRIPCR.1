         mcopy stripcr.mac         gen   on;................................................................;; STRIPCR - Shell filter to replace <CR> chars with a space.;           This is useful to put line-by-line output from some previous;           command onto one physical line.  That is, in *SMALL* files!;;           There are no parameters, but the program must run under a Shell.;           <Control><Shift><2> will exit if input is accidently requested;           from the keyboard instead of redirected input.;;           V1.0 Copyright by Peter Watson. Feb 1990;;................................................................         longa on         longi onSTRIPCR  start         gblc  &VER&VER     setc  '1.0'                    Program versionChar     equ   0                        Zero page equateErrCode  equ   4                        Error codeC_Return  equ  13                       Carriage return control characterC_Replace equ  32                       Replacement character = <space>;................................................................         phk                            Push program bank         plb                            Data bank = program bank         stz   ErrCode                  Initialize error code         stx   Char                     Check for Shell entry         tya         ora   Char         beq   Err_Exit                 Not a shell call - exit now;................................................................;; Read input and echo to output;MainLoop anop         pea   0                        Result space         pea   0                        No echo required        _ReadChar                       Call the toolbox         bcc   *+5         brl   ToolErr                  Handle a tool error         pla                            Get the character         sta   Char                     Save for later         and   #$007f                   Strip any high bit         cmp   #$0000                   End-of-file?         bne   *+5                      No, go write the character         brl   Exit                     Else say goodbye; Check for <CR> and replace with a space         cmp   #C_Return                <CR> character?         bne   DoWrite                  No, go write it out         lda   Char                     Get the old character         and   #$0080                   Leave only the high bit, if set         ora   #C_Replace               Use the replacement character         sta   Char; Echo the character to standard outputDoWrite  anop         pushword Char                  Push as parameter        _writechar                      Echo to standard output         bcc   *+5         brl   ToolErr                  Handle a tool error;................................................................;; Check for Open-Apple-Period request to abandon ship;         stz   Char                     Default - no exit         shortm         lda   $E0C025                  Look for Open-Apple modifier         bpl   KeyDone                  No, continue         lda   #'.'+$80                 Test for period ( with high bit)         cmp   $E0C000                  Compare with keystroke         bne   KeyDone                  Not equal         inc   Char                     Say - exit!KeyDone  lda   $E0C010                  Reset strobe always         longm         lda   Char                     Get exit yes/no flag         bne   Exit                     Yes, so handle STOP request;................................................................;; Loop again;         brl   MainLoop                 Go around for some more;................................................................;; Handle an error from readch;;................................................................ToolErr  anop         sta   ErrCode                  Save error code         writeln ErrMsg                 Tell the user there is a problemErr_Exit anop                           Entry if not under a Shell        _SysBeep;................................................................;; Return to our caller;Exit     anop         lda   ErrCode                  Load return code         rtl                            Return to the Shell;................................................................;; Data areas;Eyeball  dc    c'&SYSNAME - v&VER Copyright Peter Watson, &SYSDATE &SYSTIME'ErrMsg   str   'Tool error - see status code'         end