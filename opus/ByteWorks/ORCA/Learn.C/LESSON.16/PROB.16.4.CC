/* XREF                                                         *//*                                                              *//* This program generates a cross reference of a C program,     *//* showing where any symbol is used.  To use XREF, start by     *//* selecting the shell window.  Type                            *//*                                                              *//*    xref filename                                             *//*                                                              *//* where filename is the name of the program you want to cross- *//* reference.                                                   */#include <stdio.h>#include <ctype.h>#include <string.h>#include <stdlib.h>#define symbolLength 80                 /* max length of a symbol */char fName[65];                         /* file name */FILE *f;                                /* file variable */char *fNamePtr;                         /* pointer to the file name */typedef struct lineStruct {             /* line number list */   struct lineStruct *next;   int number;   }   lineStruct, *linePtr;typedef struct symbolStruct {           /* symbol table entry */   struct symbolStruct *left, *right;   char symbol[symbolLength+1];   int reserved;   linePtr lines;   }   symbolStruct, *symbolPtr;symbolPtr symbols = NULL;               /* symbol table */int lineNumber = 1;                     /* current line number */char ch = ' ';                          /* current character */char token[symbolLength+1];             /* current token */int tokenLine;                          /* line number at start of token */void GetCh (void)/* Read a character from the file                               *//*                                                              *//* Variables:                                                   *//*    ch - character read                                       *//*    lineNumber - current line number                          */{ch = fgetc(f);if (ch == '\n')   ++lineNumber;}void SkipComment (void)/* Skip comments in the program                                 */{do {   GetCh();   if (ch == '*') {      GetCh();      if (ch == '/')         return;      }   }while (ch != EOF);}void NextCh (void)/* Get the next character from the file, skipping comments      */{GetCh();                                /* get the next character */if (ch == '/') {                        /* skip comments */   GetCh();   if (ch == '*') {      GetCh();      SkipComment();      }   }}void GetToken (void)/* Read a word from the source file                             *//*                                                              *//* Variables:                                                   *//*    lineNumber - current line number                          *//*    token - string read                                       *//*    tokenLine - line number at the start of the token         */{int len = 0;                            /* length of the token */if (ch != EOF) {                                        /* skip to the next token */   while ((!iscsymf(ch)) && (ch != EOF))      GetCh();   tokenLine = lineNumber;              /* record the line number */                                        /* record the token */   while (iscsym(ch) && (ch != EOF)) {      if (len < symbolLength) {         token[len] = ch;         ++len;         }      GetCh();      }   }token[len] = (char) 0;                  /* mark the end of the string */}void AddUse (symbolPtr ptr)/* Add a line number to the symbol table entry                  *//*                                                              *//* Parameters:                                                  *//*    ptr - symbol table entry to update                        *//*                                                              *//* Variables:                                                   *//*    tokenLine - line number at the start of the token         */{linePtr lPtr;                           /* current line number pointer */lPtr = (linePtr) malloc(sizeof(lineStruct));lPtr->next = ptr->lines;ptr->lines = lPtr;lPtr->number = tokenLine;}void Insert (symbolPtr *ptr, int reserved)/* Insert a symbol use in the symbol table.  If the symbol does *//* not exist, create a new entry.                               *//*                                                              *//* Parameters:                                                  *//*    ptr - pointer to the top node of the tree                 *//*    reserved - is this a reserved word?                       *//*                                                              *//* Variables:                                                   *//*    token - symbol to insert                                  */{symbolPtr sPtr;                         /* work pointer */int cmp;                                /* result of strcmp */if (*ptr == NULL) {                     /* no entry: create one */   sPtr = (symbolPtr) malloc(sizeof(symbolStruct));   sPtr->left = NULL;   sPtr->right = NULL;   strcpy(sPtr->symbol, token);   sPtr->reserved = reserved;   sPtr->lines = NULL;   *ptr = sPtr;                         /* add it to the tree */   if (!reserved)                       /* mark the line number */      AddUse(sPtr);   }else {   cmp = strcmp(token, (*ptr)->symbol);   if (cmp < 0)      Insert(&((*ptr)->left), reserved); /* follow the left link */   else if (cmp > 0)      Insert(&((*ptr)->right), reserved); /* follow the right link */   else if (!(*ptr)->reserved)      AddUse(*ptr);                     /* found an existing entry */   }}void PrintNumber (linePtr nPtr)/* Recursively print the line numbers in reverse order          *//*                                                              *//* Parameters:                                                  *//*    nPtr - pointer to the remainder of the line number list   */{if (nPtr != NULL) {   PrintNumber(nPtr->next);   printf("%d ", nPtr->number);   }}void PrintSymbols (symbolPtr ptr)/* Print the symbols found and line numbers                     *//*                                                              *//* Parameters:                                                  *//*    ptr - pointer to the next node in the symbol table        */{if (ptr != NULL) {   PrintSymbols(ptr->left);             /* print symbols to the left */   if (!ptr->reserved) {      printf("%16s  ", ptr->symbol);    /* print this symbol */      PrintNumber(ptr->lines);      printf("\n");      }   PrintSymbols(ptr->right);            /* print symbols to the right */   }}void ReservedWords (void)/* Add the C reserved words to the symbol table */{strcpy(token, "if");            Insert(&symbols, 1);strcpy(token, "default");       Insert(&symbols, 1);strcpy(token, "case");          Insert(&symbols, 1);strcpy(token, "asm");           Insert(&symbols, 1);strcpy(token, "auto");          Insert(&symbols, 1);strcpy(token, "break");         Insert(&symbols, 1);strcpy(token, "comp");          Insert(&symbols, 1);strcpy(token, "char");          Insert(&symbols, 1);strcpy(token, "continue");      Insert(&symbols, 1);strcpy(token, "const");         Insert(&symbols, 1);strcpy(token, "extended");      Insert(&symbols, 1);strcpy(token, "double");        Insert(&symbols, 1);strcpy(token, "do");            Insert(&symbols, 1);strcpy(token, "enum");          Insert(&symbols, 1);strcpy(token, "else");          Insert(&symbols, 1);strcpy(token, "float");         Insert(&symbols, 1);strcpy(token, "extern");        Insert(&symbols, 1);strcpy(token, "goto");          Insert(&symbols, 1);strcpy(token, "for");           Insert(&symbols, 1);strcpy(token, "sizeof");        Insert(&symbols, 1);strcpy(token, "register");      Insert(&symbols, 1);strcpy(token, "int");           Insert(&symbols, 1);strcpy(token, "inline");        Insert(&symbols, 1);strcpy(token, "pascal");        Insert(&symbols, 1);strcpy(token, "long");          Insert(&symbols, 1);strcpy(token, "segment");       Insert(&symbols, 1);strcpy(token, "return");        Insert(&symbols, 1);strcpy(token, "signed");        Insert(&symbols, 1);strcpy(token, "short");         Insert(&symbols, 1);strcpy(token, "union");         Insert(&symbols, 1);strcpy(token, "struct");        Insert(&symbols, 1);strcpy(token, "static");        Insert(&symbols, 1);strcpy(token, "typedef");       Insert(&symbols, 1);strcpy(token, "switch");        Insert(&symbols, 1);strcpy(token, "void");          Insert(&symbols, 1);strcpy(token, "unsigned");      Insert(&symbols, 1);strcpy(token, "while");         Insert(&symbols, 1);strcpy(token, "volatile");      Insert(&symbols, 1);}int main (int argc, char *argv[])/* Main program                                                 */{if (argc < 2) {                         /* get a file name */   printf("File to cross reference: ");   fNamePtr = fName;   scanf("%64s", fName);   if (strlen(fName) == 0)      return -1;   }else {   if (argc > 2)      printf("Extra input ignored.\n");   fNamePtr = argv[1];   }f = fopen(fNamePtr, "r");               /* open the file */if (f == NULL) {   printf("Could not open %s.\n", fNamePtr);   return -1;   }ReservedWords();                        /* add the reserved words */do {                                    /* collect the symbols in the file */   GetToken();   if (strlen(token))      Insert(&symbols, 0);   }while (strlen(token));PrintSymbols(symbols);                  /* print the symbol table */fclose(f);                              /* close the file */return 0;                               /* return with no error */}