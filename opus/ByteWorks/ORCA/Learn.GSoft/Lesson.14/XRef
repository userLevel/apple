      REM XREF      REM      REM This program generates a cross reference of a BASIC      REM program, showing where any symbol is used.      ! line number list      TYPE LINERECORD        NEXTP AS POINTER TO LINERECORD        NUMBER AS INTEGER      END TYPE      TYPE LINEPTR AS POINTER TO LINERECORD      ! symbol table entry      TYPE SYMBOLRECORD        NEXTP AS POINTER TO SYMBOLRECORD        SYMBOL AS STRING        LINES AS LINEPTR      END TYPE      TYPE SYMBOLPTR AS POINTER TO SYMBOLRECORD      CONST F = 1:! file number      DIM CH AS STRING :! current character      DIM FNAME AS STRING :! file name      DIM LINE$ AS STRING :! current line      DIM LINEINDEX AS INTEGER :! index into line$      DIM LINENUMBER AS INTEGER :! current line number      DIM SYMBOLS AS SYMBOLPTR:! symbol table      DIM TOKEN AS STRING :! current token      DIM TOKENLINE AS INTEGER :! line number at start of token      ! nothing in the symbol table      SYMBOLS = NIL      ! first line      LINENUMBER = 0      ! get the file name      FNAME = GETFILENAME      IF LEN (FNAME) <> 0 THEN        ! initialize the scanner        OPEN FNAME FOR INPUT AS #F        CH = " "        LINE$ = ""        LINEINDEX = 0        CALL NEXTCH        ! find all of the symbols        DO          CALL NEXTTOKEN          IF LEN (TOKEN) <> 0 THEN            CALL INSERT          END IF        LOOP UNTIL LEN (TOKEN) = 0        ! print the symbols        CALL PRINTSYMBOLS        ! dispose of the symbol table        CALL DISPOSESYMBOLS        ! close the file        CLOSE #F      END IF      END      !----------------------------------------------------------      !      ! DisposeSymbols - dispose of the symbol table      !      ! Shared Variables:      !    symbols - pointer to the first entry in the symbol table      !      !----------------------------------------------------------      SUB DISPOSESYMBOLS      SHARED SYMBOLS      DIM LPTR AS LINEPTR:! work line pointer      DIM SPTR AS SYMBOLPTR:! work symbol pointer      WHILE SYMBOLS <> NIL        ! remove the symbol from the symbol table        SPTR = SYMBOLS        SYMBOLS = SPTR^.NEXTP        ! dispose of the lines        WHILE SPTR^.LINES <> NIL          ! remove the line from the line list          LPTR = SPTR^.LINES          SPTR^.LINES = LPTR^.NEXTP          ! dispose of the line record          DISPOSE (LPTR)        WEND        ! dispose of the symbol record        DISPOSE (SPTR)      WEND      END SUB      !----------------------------------------------------------      !      ! GetFileName - get the name of the file to cross-reference      !      !----------------------------------------------------------      FUNCTION GETFILENAME AS STRING      DIM NAME$ AS STRING :! file name      INPUT "File to cross-reference: ";NAME$      GETFILENAME = NAME$      END FUNCTION      !----------------------------------------------------------      !      ! Insert - insert a symbol use in the symbol table      !      ! Shared Variables:      !    tokenLine - line number at the start of the token      !    token - symbol to insert      !    symbols - pointer to the first entry in the sybol table      !      !----------------------------------------------------------      SUB INSERT      SHARED TOKENLINE, TOKEN, SYMBOLS      DIM LPTR AS LINEPTR:! current line number pointer      DIM SPTR AS SYMBOLPTR:! current symbol pointer      DIM WPTR AS SYMBOLPTR:! work symbol pointer      ! try to find the symbol      SPTR = NIL      WPTR = SYMBOLS      WHILE WPTR <> NIL        IF TOKEN = WPTR^.SYMBOL THEN          SPTR = WPTR          WPTR = NIL        ELSE          WPTR = WPTR^.NEXTP        END IF      WEND      ! if the symbol isn't in the table then create a new entry      IF SPTR = NIL THEN        ALLOCATE (SPTR)        IF SPTR <> NIL THEN          SPTR^.NEXTP = SYMBOLS          SYMBOLS = SPTR          SPTR^.SYMBOL = TOKEN          SPTR^.LINES = NIL        END IF      END IF      ! enter the line number      IF SPTR <> NIL THEN        ALLOCATE (LPTR)        IF LPTR <> NIL THEN          LPTR^.NEXTP = SPTR^.LINES          SPTR^.LINES = LPTR          LPTR^.NUMBER = TOKENLINE        END IF      END IF      END SUB      !----------------------------------------------------------      !      ! NextCh - get the next character from the file      !      ! Shared Variables:      !    ch - next character from the file      !    f - file number      !    line$ - current line from the file      !    lineindex - index of the character ch in line$      !    linenumber - current line number      !      ! Notes: The end of a line is reported as a space      !    character.  All characters are converted to uppercase.      !      !----------------------------------------------------------      SUB NEXTCH      SHARED CH, F, LINE$, LINEINDEX, LINENUMBER      ! if we need one, get a new line      IF LINEINDEX > LEN (LINE$) THEN        IF EOF (F) THEN          CH = ""        ELSE          LINE INPUT #F, LINE$          LINEINDEX = 0          LINENUMBER = LINENUMBER + 1        END IF      END IF      ! check for an end of file      IF LEN (CH) <> 0 THEN        LINEINDEX = LINEINDEX + 1        IF LINEINDEX > LEN (LINE$) THEN          ! handle an end of line          CH = " "        ELSE          ! report the next character          CH = MID$ (LINE$, LINEINDEX, 1)          IF CH >= "a" AND CH <= "z" THEN            CH = CHR$ ( ASC (CH) - 32)          END IF        END IF      END IF      END SUB      !----------------------------------------------------------      !      ! NextToken - read a word from the file      !      ! Shared Variables:      !    ch - next character from the file      !    token - string in which to return the token      !      !----------------------------------------------------------      SUB NEXTTOKEN      SHARED CH, TOKEN, TOKENLINE, LINENUMBER      ! initialize the token      TOKEN = ""      ! find the next token      DO        ! record the line number for the token        TOKENLINE = LINENUMBER        IF CH = "!" THEN          ! handle a comment          WHILE ASC (CH) <> 0 AND TOKENLINE = LINENUMBER            CALL NEXTCH          WEND        ELSE IF CH >= "0" AND CH <= "9" THEN          ! handle a number          WHILE CH >= "0" AND CH <= "9"            CALL NEXTCH          WEND          IF CH = "E" OR CH = "D" THEN            CALL NEXTCH            IF CH = "-" OR CH = "+" THEN              CALL NEXTCH            END IF            WHILE CH >= "0" AND CH <= "9"              CALL NEXTCH            WEND          END IF        ELSE IF ASC (CH) = 34 THEN          ! handle a string constant          CALL NEXTCH          WHILE ASC (CH) <> 34 AND TOKENLINE = LINENUMBER            CALL NEXTCH          WEND          IF ASC (CH) = 34 THEN            CALL NEXTCH          END IF        ELSE IF (CH >= "A" AND CH <= "Z") OR (CH = "_") THEN          ! handle a token          WHILE (CH >= "A" AND CH <= "Z") OR (CH >= "0" AND CH <= "9") OR (CH = "_")            TOKEN = TOKEN + CH            CALL NEXTCH          WEND        ELSE IF ASC (CH) <> 0 THEN          ! handle any other character          CALL NEXTCH        END IF      LOOP UNTIL ASC (CH) = 0 OR LEN (TOKEN) <> 0      END SUB      !----------------------------------------------------------      !      ! PrintNumber - recursively print the line numbers      !      ! Parameters:      !    nPtr - pointer to the remainder of the line number list      !      !----------------------------------------------------------      SUB PRINTNUMBER(NPTR AS LINEPTR)      IF NPTR <> NIL THEN        CALL PRINTNUMBER(NPTR^.NEXTP)        PRINT NPTR^.NUMBER;" ";      END IF      END SUB      !----------------------------------------------------------      !      ! PrintSymbols - print the symbols and line numbers      !      ! Shared Variables:      !    symbols - pointer to the first entry in the symbol table      !      !----------------------------------------------------------      SUB PRINTSYMBOLS      SHARED SYMBOLS      DIM SPTR AS SYMBOLPTR:! current symbol pointer      SPTR = SYMBOLS      WHILE SPTR <> NIL        PRINT SPTR^.SYMBOL, ;        CALL PRINTNUMBER(SPTR^.LINES)        PRINT        SPTR = SPTR^.NEXTP      WEND      END SUB