 MACRO&LAB PUTS &N1,&F1,&CR,&ERROUT&LAB ~SETM LCLC &C&C AMID "&N1",1,1 AIF "&C"<>"#",.C AIF L:&N1>127,.A BRA ~&SYSCNT AGO .B.A BRL ~&SYSCNT.B&N1 AMID "&N1",2,L:&N1-1~L&SYSCNT DC I1"L:~S&SYSCNT"~S&SYSCNT DC C&N1~&SYSCNT ANOP&N1 SETC ~L&SYSCNT-1 AIF C:&F1=0,.D.C ~PUSHA &N1 AIF C:&F1,.C1 PEA 0 AGO .C2.C1 PH2 &F1.C2 PH2 #C:&CR PH2 #C:&ERROUT JSL ~PUTS ~RESTM MEXIT.D PEA ~L&SYSCNT|-16 PEA ~L&SYSCNT LDX #$1C0C+(C:&ERROUT*256)-(512*C:&CR) JSL $E10000 ~RESTM MEND MACRO&LAB PUTCR &ERROUT&LAB ~SETM PEA $0D LDX #$180C+(256*C:&ERROUT) JSL $E10000 PEA $0A LDX #$180C+(256*C:&ERROUT) JSL $E10000 ~RESTM MEND MACRO&LAB ~PUSHA &N1 LCLC &C&LAB ANOP&C AMID &N1,1,1 AIF "&C"<>"{",.B&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.G&N1 AMID &N1,2,L:&N1-2 SEP #$20 LONGA OFF LDA #0 PHA REP #$20 LONGA ON PHK LDA &N1 PHA MEXIT.B AIF "&C"<>"[",.C&N1 AMID &N1,2,L:&N1-2 LDA &N1+2 PHA LDA &N1 PHA MEXIT.C PEA +(&N1)|-16 PEA &N1 MEXIT.G MNOTE "Missing closing '}'",16 MEND MACRO&LAB ~SETM&LAB ANOP AIF C:&~LA,.B GBLB &~LA GBLB &~LI.B&~LA SETB S:LONGA&~LI SETB S:LONGI AIF S:LONGA.AND.S:LONGI,.A REP #32*(.NOT.&~LA)+16*(.NOT.&~LI) LONGA ON LONGI ON.A MEND MACRO&LAB ~RESTM&LAB ANOP AIF (&~LA+&~LI)=2,.I SEP #32*(.NOT.&~LA)+16*(.NOT.&~LI) AIF &~LA,.H LONGA OFF.H AIF &~LI,.I LONGI OFF.I MEND MACRO&LAB ADD2 &N1,&N2,&N3 AIF C:&N3,.A LCLC &N3&N3 SETC &N1.A&LAB ~SETM CLC ~LDA &N1 ~OP ADC,&N2 ~STA &N3 ~RESTM MEND MACRO&LAB ~LDA &OP LCLC &C&C AMID "&OP",1,1 AIF "&C"<>"{",.B&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B&LAB LDA &OP MEND MACRO&LAB ~STA &OP LCLC &C&C AMID "&OP",1,1 AIF "&C"<>"{",.B&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B&LAB STA &OP MEND MACRO&LAB ~OP &OPC,&OP LCLC &C&C AMID "&OP",1,1 AIF "&C"<>"{",.B&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B&LAB &OPC &OP MEND MACRO&LAB ADD4 &M1,&M2,&M3 LCLB &YISTWO LCLC &C&LAB ~SETM AIF C:&M3,.A&C AMID "&M2",1,1 AIF "&C"<>"#",.A&C AMID "&M1",1,1 AIF "&C"="{",.A AIF "&C"="[",.A&C AMID "&M2",2,L:&M2-1 AIF &C>=65536,.A CLC ~LDA &M1 ~OP ADC,&M2 ~STA &M1 BCC ~&SYSCNT ~OP.H INC,&M1~&SYSCNT ANOP AGO .C.A AIF C:&M3,.B LCLC &M3&M3 SETC &M1.B CLC ~LDA &M1 ~OP ADC,&M2 ~STA &M3 ~LDA.H &M1 ~OP.H ADC,&M2 ~STA.H &M3.C ~RESTM MEND MACRO&LAB CMP4 &N1,&N2 LCLB &YISTWO&LAB ~SETM ~LDA.H &N1 ~OP.H EOR,&N2 BPL ~A&SYSCNT ~LDA.H &N2 ~OP.H CMP,&N1 BRA ~B&SYSCNT~A&SYSCNT ~LDA.H &N1 ~OP.H CMP,&N2 BNE ~B&SYSCNT ~LDA &N1 ~OP CMP,&N2~B&SYSCNT ANOP ~RESTM MEND MACRO&LAB ~OP.H &OPC,&OP&LAB ANOP LCLC &C&C AMID "&OP",1,1 AIF "&C"="[",.B AIF "&C"<>"{",.D&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B AIF &YISTWO,.C&YISTWO SETB 1 LDY #2&OP SETC "&OP,Y".C &OPC &OP MEXIT.D AIF "&C"<>"#",.E&OP AMID "&OP",2,L:&OP-1&OP SETC "#^&OP" &OPC &OP MEXIT.E &OPC 2+&OP MEND MACRO&LAB ~LDA.H &OP&LAB ANOP LCLC &C&C AMID "&OP",1,1 AIF "&C"="[",.B AIF "&C"<>"{",.D&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B AIF &YISTWO,.C&YISTWO SETB 1 LDY #2&OP SETC "&OP,Y".C LDA &OP MEXIT.D AIF "&C"<>"#",.E&OP AMID "&OP",2,L:&OP-1&OP SETC "#^&OP" LDA &OP MEXIT.E LDA 2+&OP MEND MACRO&LAB ~STA.H &OP&LAB ANOP LCLC &C&C AMID "&OP",1,1 AIF "&C"="[",.B AIF "&C"<>"{",.D&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B AIF &YISTWO,.C&YISTWO SETB 1 LDY #2&OP SETC "&OP,Y".C STA &OP MEXIT.D STA 2+&OP MEND MACRO&LAB BGT &BP&LAB BEQ *+4 BGE &BP MEND MACRO&LAB BLE &BP&LAB BLT &BP BEQ &BP MEND MACRO&LAB CNVS2 &N1,&N2 AIF C:&N2,.A LCLC &N2&N2 SETC &N1.A&LAB ~SETM ~PUSHA &N1 JSL ~CVS2 ~STA &N2 ~RESTM MEND MACRO&LAB DBEQ &R,&BP AIF "&R"="X",.L1 AIF "&R"="Y",.L1&LAB DEC &R BEQ &BP MEXIT.L1&LAB DE&R BEQ &BP MEND MACRO&LAB DBNE &R,&BP AIF "&R"="X",.L1 AIF "&R"="Y",.L1&LAB DEC &R BNE &BP MEXIT.L1&LAB DE&R BNE &BP MEND MACRO&LAB DBPL &R,&BP AIF "&R"="X",.L1 AIF "&R"="Y",.L1&LAB DEC &R BPL &BP MEXIT.L1&LAB DE&R BPL &BP MEND MACRO&LAB DSTR &ADR,&LENGTH AIF C:&LENGTH=0,.C AIF C:&ADR=0,.B LCLA &N&N SETA &LENGTH AIF &N>=L:&ADR,.A&N SETA L:&ADR.A&LAB DC I1"&N" DC I1"L:SYSA&SYSCNT"SYSA&SYSCNT DC C"&ADR" DS &N-L:SYSA&SYSCNT MEXIT.B&LAB DC I1"&LENGTH" DC I1"0" DS &LENGTH MEXIT.C&LAB DC I1"L:SYSA&SYSCNT" DC I1"L:SYSA&SYSCNT"SYSA&SYSCNT DC C"&ADR" MEND MACRO&LAB DW &ADR&LAB DC I1"L:SYSA&SYSCNT"SYSA&SYSCNT DC C"&ADR" MEND MACRO&LAB INC2 &N1 LCLC &C&LAB ANOP AIF S:LONGA=1,.A REP #%00100000.A&C AMID &N1,1,1 AIF "&C"<>"{",.B&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.F&N1 AMID &N1,2,L:&N1-2 LDA (&N1) INC A STA (&N1) AGO .D.B AIF "&C"<>"[",.C LDA &N1 INC A STA &N1 AGO .D.C INC &N1.D AIF S:LONGA=1,.E SEP #%00100000.E MEXIT.F MNOTE "Missing closing '}'",16 MEND MACRO&LAB INC4 &A&LAB ~SETM INC &A BNE ~&SYSCNT INC 2+&A~&SYSCNT ~RESTM MEND MACRO&LAB JCS &BP&LAB BCC *+5 BRL &BP MEND MACRO&LAB JEQ &BP&LAB BNE *+5 BRL &BP MEND MACRO&LAB JGE &BP&LAB BLT *+5 BRL &BP MEND MACRO&LAB JMI &BP&LAB BPL *+5 BRL &BP MEND MACRO&LAB JNE &BP&LAB BEQ *+5 BRL &BP MEND MACRO&LAB LA &AD1,&AD2&LAB ANOP LCLA &L LCLB &LA AIF S:LONGA,.A REP #%00100000 LONGA ON&LA SETB 1.A LDA #&AD2&L SETA C:&AD1.B STA &AD1(&L)&L SETA &L-1 AIF &L,^B AIF &LA=0,.D SEP #%00100000 LONGA OFF.D MEND MACRO&LAB LLA &AD1,&AD2&LAB ANOP LCLA &L LCLB &LA AIF S:LONGA,.A REP #%00100000 LONGA ON&LA SETB 1.A LDA #&AD2&L SETA C:&AD1.B STA &AD1(&L)&L SETA &L-1 AIF &L,^B LDA #^&AD2&L SETA C:&AD1.C STA 2+&AD1(&L)&L SETA &L-1 AIF &L,^C AIF &LA=0,.D SEP #%00100000 LONGA OFF.D MEND MACRO&LAB LM &AD1,&AD2&LAB ANOP LCLA &L LCLB &LA AIF .NOT.S:LONGA,.A SEP #%00100000 LONGA OFF&LA SETB 1.A LDA &AD2&L SETA C:&AD1.B STA &AD1(&L)&L SETA &L-1 AIF &L,^B AIF &LA=0,.C REP #%00100000 LONGA ON.C MEND MACRO&LAB LONG &A,&B LCLB &I LCLB &M&A AMID &A,1,1&M SETB "&A"="M"&I SETB "&A"="I" AIF C:&B=0,.A&B AMID &B,1,1&M SETB ("&B"="M").OR.&M&I SETB ("&B"="I").OR.&I.A&LAB REP #&M*32+&I*16 AIF .NOT.&M,.B LONGA ON.B AIF .NOT.&I,.C LONGI ON.C MEND MACRO&LAB MOVE &AD1,&AD2,&LEN&LAB ANOP LCLB &LA LCLB &LI LCLC &C AIF C:&LEN,.A1 LCLC &LEN&LEN SETC #2.A1&LA SETB S:LONGA&LI SETB S:LONGI AIF S:LONGA.AND.S:LONGI,.A REP #32*(.NOT.&LA)+16*(.NOT.&LI) LONGA ON LONGI ON.A&C AMID &LEN,1,1 AIF "&C"<>"#",.D&C AMID &LEN,2,L:&LEN-1 AIF &C<>2,.D&C AMID &AD1,1,1 AIF "&C"<>"{",.B&AD1 AMID &AD1,2,L:&AD1-2&AD1 SETC (&AD1).B LDA &AD1&C AMID &AD2,1,1 AIF "&C"<>"{",.C&AD2 AMID &AD2,2,L:&AD2-2&AD2 SETC (&AD2).C STA &AD2 AGO .G.D&C AMID &AD1,1,1 AIF "&C"="#",.F&C AMID &LEN,1,1 AIF "&C"<>"{",.E&LEN AMID &LEN,2,L:&LEN-2&LEN SETC (&LEN).E&C AMID &LEN,1,1 AIF "&C"="#",.E1 LDA &LEN DEC A AGO .E2.E1 LDA &LEN-1.E2 LDX #&AD1 LDY #&AD2 MVN &AD1,&AD2 AGO .G.F LDA &AD1 STA &AD2 LDA &LEN-1 LDX #&AD2 LDY #&AD2+1 MVN &AD2,&AD2.G AIF (&LA+&LI)=2,.I SEP #32*(.NOT.&LA)+16*(.NOT.&LI) AIF &LA,.H LONGA OFF.H AIF &LI,.I LONGI OFF.I MEND MACRO&LAB PH2 &N1 LCLC &C&LAB ANOP&C AMID &N1,1,1 AIF "&C"="#",.D AIF S:LONGA=1,.A REP #%00100000.A AIF "&C"<>"{",.B&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.G&N1 AMID &N1,2,L:&N1-2 LDA (&N1) PHA AGO .E.B LDA &N1 PHA AGO .E.D&N1 AMID &N1,2,L:&N1-1 PEA &N1 AGO .F.E AIF S:LONGA=1,.F SEP #%00100000.F MEXIT.G MNOTE "Missing closing '}'",16 MEND MACRO&LAB SHORT &A,&B LCLB &I LCLB &M&A AMID &A,1,1&M SETB "&A"="M"&I SETB "&A"="I" AIF C:&B=0,.A&B AMID &B,1,1&M SETB ("&B"="M").OR.&M&I SETB ("&B"="I").OR.&I.A&LAB SEP #&M*32+&I*16 AIF .NOT.&M,.B LONGA OFF.B AIF .NOT.&I,.C LONGI OFF.C MEND MACRO&LAB CLOSE &DCB&LAB JSL $E100A8 DC I2'$14' DC I4'&DCB' MEND MACRO&LAB CREATE &DCB&LAB JSL $E100A8 DC I2'$01' DC I4'&DCB' MEND MACRO&LAB GET_FILE_INFO &DCB&LAB JSL $E100A8 DC I2'$06' DC I4'&DCB' MEND MACRO&LAB OPEN &DCB&LAB JSL $E100A8 DC I2'$10' DC I4'&DCB' MEND MACRO&LAB QUIT &DCB&LAB JSL $E100A8 DC I2'$29' DC I4'&DCB' MEND MACRO&LAB READ &DCB&LAB JSL $E100A8 DC I2'$12' DC I4'&DCB' MEND MACRO&LAB SET_EOF &DCB&LAB JSL $E100A8 DC I2'$18' DC I4'&DCB' MEND MACRO&LAB WRITE &DCB&LAB JSL $E100A8 DC I2'$13' DC I4'&DCB' MEND MACRO&LAB ERROR &DCB&LAB ~SETM JSL $E100A8 DC I2'$0105' DC I4'&DCB' ~RESTM MEND MACRO&LAB STOP &DCB&LAB ~SETM JSL $E100A8 DC I2'$0113' DC I4'&DCB' ~RESTM MEND MACRO&LAB _WRITECHAR&LAB LDX #$180C JSL $E10000 MEND MACRO&LAB _READCHAR&LAB LDX #$220C JSL $E10000 MEND MACRO&LAB STORE&LAB INC X1 DEC SIZE JEQ END MEND MACRO&LAB UNLOCK &H&LAB ~SETM LDA 2+&H PHA LDA &H PHA LDX #$2202 JSL $E10000 ~RESTM MEND MACRO&LAB GROW &H,&S&LAB ~SETM LCLC &C&C AMID "&S",1,1 AIF "&C"="#",.A LDA 2+&S PHA LDA &S PHA AGO .B.A&S AMID "&S",2,L:&S-1 PEA &S|-16 PEA &S.B LDA 2+&H PHA LDA &H PHA LDX #$1902 JSL $E10000 ~RESTM MEND MACRO&LAB TERR &N&LAB LDX &N BRL STERR MEND MACRO&LAB LOCK &H,&P&LAB ~SETM LDA 2+&H PHA LDA &H PHA LDX #$2002 JSL $E10000 AIF .NOT.C:&P,.A PHA LDA &H STA LOCKP LDA 2+&H STA LOCKP+2 LDA [LOCKP] STA &P LDY #2 LDA [LOCKP],Y STA 2+&P PLA.A ~RESTM MEND MACRO&LAB NEW &H,&S,&BANK,&PAGE,&ADDR&LAB ~SETM LCLC &C PEA +(&H)|-16 PEA &H&C AMID "&S",1,1 AIF "&C"="#",.A LDA 2+&S AND #$00FF PHA LDA &S PHA AGO .B.A&S AMID "&S",2,L:&S-1 PEA +(&S)|-16 PEA &S.B LDA USER_ID PHA PEA 16+C:&PAGE*4+C:&ADDR*$4002+C:&BANK AIF C:&ADDR,.E AIF C:&BANK,.C PHA PHA AGO .G.C&C AMID "&BANK",1,1 AIF "&C"="#",.D LDA 2+&BANK PHA LDA &BANK PHA AGO .G.D&BANK AMID "&BANK",2,L:&BANK-1 PEA &BANK|-16 PEA &BANK AGO .G.E&C AMID "&ADDR",1,1 AIF "&C"="#",.F LDA 2+&ADDR PHA LDA &ADDR PHA AGO .G.F&ADDR AMID "&ADDR",2,L:&ADDR-1 PEA +(&ADDR)|-16 PEA &ADDR.G LDX #$0902 JSL $E10000 PLX STX &H PLX STX 2+&H ~RESTM MEND MACRO&LAB DISPOSEALL &I&LAB ~SETM LDA &I PHA LDX #$1102 JSL $E10000 ~RESTM MEND