******************************************************************  M6502.MSC**  Miscellaneous macros.**  By Mike Westerfield*  Copyright (C) December 1984, All rights reserved*  By the Byte Works, Inc.*****************************************************************         MACRO&LAB     BUTTON &BTN,&VAL&LAB     ANOP         LDX   &BTN         LDA   $C061,X         AIF   C:&VAL=0,.PVAL         STA   &VAL.PVAL         MEND         MACRO&LAB     CNV24 &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVXY &N1,&N2,2,4,000,001,I         MEND         MACRO&LAB     CNV28 &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVXY &N1,&N2,2,8,000,010,I         MEND         MACRO&LAB     CNV2S &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVSX &N1,&N2,000,111,I,SYSCTST,SYSPUT2         MEND         MACRO&LAB     CNV42 &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVXY &N1,&N2,4,2,001,000,I4         MEND         MACRO&LAB     CNV48 &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVXY &N1,&N2,4,8,001,010,I4         MEND         MACRO&LAB     CNV4S &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVSX &N1,&N2,001,111,I4,SYSCTST,SYSPUT4         MEND         MACRO&LAB     CNV82 &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVXY &N1,&N2,8,2,010,000,I8         MEND         MACRO&LAB     CNV84 &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVXY &N1,&N2,8,4,010,001,I8         MEND         MACRO&LAB     CNV8S &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVSX &N1,&N2,010,111,I8,SYSCTST,SYSPUT8         MEND         MACRO&LAB     CNVS2 &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVSX &N1,&N2,111,000,C,SYSCFST,SYSGET2         MEND         MACRO&LAB     CNVS4 &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVSX &N1,&N2,111,001,C,SYSCFST,SYSGET4         MEND         MACRO&LAB     CNVS8 &N1,&N2         AIF   C:&N2>0,.A         LCLC  &N2.A&LAB     CNVSX &N1,&N2,111,010,C,SYSCFST,SYSGET8         MEND         MACRO&LAB     CNVXY &N1,&N2,&X,&Y,&BT1,&BT2,&DC         LCLC  &C         LCLC  &C1         LCLC  &C2         LCLC  &B1         LCLC  &B2         LCLB  &ST1         AIF   "&N1"<>"*",.A&B1      SETC  011&ST1     SETB  1&C1      SETC  ANOP         AGO   .E.A&C       AMID  &N1,1,1         AIF   "&C"<>"#",.B&B1      SETC  000&N1      AMID  &N1,2,L:&N1-1&C1      SETC  "DC &DC'&N1'"         AGO   .E.B         AIF   "&C"<>"{",.C&C       AMID  &N1,L:&N1,1         AIF   "&C"<>"}",.K&N1      AMID  &N1,2,L:&N1-2&B1      SETC  010         AGO   .D.C&B1      SETC  001.D&C1      SETC  "DC I'&N1'".E         AIF   C:&N2>0,.F&B2      SETC  &B1         AIF   &ST1,.E1&C2      SETC  "DC I'&N1'"         AGO   .J.E1&C2      SETC  ANOP         AGO   .J.F         AIF   "&N2"<>"*",.G&B2      SETC  011&C2      SETC  ANOP         AGO   .J.G&C       AMID  &N2,1,1         AIF   "&C"<>"{",.H&C       AMID  &N2,L:&N2,1         AIF   "&C"<>"}",.K&N2      AMID  &N2,2,L:&N2-2&B2      SETC  010         AGO   .I.H&B2      SETC  001.I&C2      SETC  "DC I'&N2'".J&LAB     JSR   SYSBOPR+8         DC    A"SYSCV&X&Y"         DC    B"&BT1 &B1 &BT2 &B2"         &C1         &C2         MEXIT.K         MNOTE "Missing closing '}'",16         MEND         MACRO&LAB     CNVSX &N1,&N2,&BT1,&BT2,&DC,&SUB1,&SUB2         LCLC  &C         LCLC  &C1         LCLC  &C2         LCLC  &B1         LCLC  &B2         LCLB  &ST1         AIF   "&N1"<>"*",.A&B1      SETC  011&ST1     SETB  1&C1      SETC  ANOP         AGO   .E.A&C       AMID  &N1,1,1         AIF   "&C"<>"#",.B&B1      SETC  000&N1      AMID  &N1,2,L:&N1-1         AIF   "&DC"="C",.A1&C1      SETC  "DC &DC'&N1'"         AGO   .E.A1&C1      SETC  "DC C&N1"         AGO   .E.B         AIF   "&C"<>"{",.C&C       AMID  &N1,L:&N1,1         AIF   "&C"<>"}",.K&N1      AMID  &N1,2,L:&N1-2&B1      SETC  010         AGO   .D.C&B1      SETC  001.D&C1      SETC  "DC I'&N1'".E         AIF   C:&N2>0,.F&B2      SETC  &B1         AIF   &ST1,.E1&C2      SETC  "DC I'&N1'"         AGO   .J.E1&C2      SETC  ANOP         AGO   .J.F         AIF   "&N2"<>"*",.G&B2      SETC  011&C2      SETC  ANOP         AGO   .J.G&C       AMID  &N2,1,1         AIF   "&C"<>"{",.H&C       AMID  &N2,L:&N2,1         AIF   "&C"<>"}",.K&N2      AMID  &N2,2,L:&N2-2&B2      SETC  010         AGO   .I.H&B2      SETC  001.I&C2      SETC  "DC I'&N2'".J&LAB     JSR   &SUB1         DC    A"&SUB2"         DC    B"&BT1 &B1 &BT2 &B2"         &C1         &C2         MEXIT.K         MNOTE "Missing closing '}'",16         MEND         MACRO&LAB     DSTR  &ADR,&LENGTH         AIF   C:&LENGTH=0,.C         AIF   C:&ADR=0,.B         LCLA  &N&N       SETA  &LENGTH         AIF   &N>=L:&ADR,.A&N       SETA  L:&ADR.A&LAB     DC    I1"&N"         DC    I1"L:SYSA&SYSCNT"SYSA&SYSCNT DC C"&ADR"         DS    &N-L:SYSA&SYSCNT         MEXIT.B&LAB     DC    I1"&LENGTH"         DC    I1"0"         DS    &LENGTH         MEXIT.C&LAB     DC    I1"L:SYSA&SYSCNT"         DC    I1"L:SYSA&SYSCNT"SYSA&SYSCNT DC C"&ADR"         MEND         MACRO&LAB     DW    &ADR&LAB     DC    I1"L:SYSA&SYSCNT"SYSA&SYSCNT DC C"&ADR"         MEND         MACRO&LAB     ERROR &ERR&LAB     LDX   &ERR         JSR   SYSEROR         MEND         MACRO&LAB     FLASH&LAB     LDA   #$7F         STA   $32         MEND         MACRO&LAB     INITSTACK &LEN         AIF   C:SYSESTE>0,.XXSYSESTE  EQU   $98.XX         LCLC  &IM         LCLC  &LOW         LCLC  &HIGH&LAB     LDA   #SYSESTMAX         STA   WR0         LDA   #>SYSESTMAX         STA   WR1&IM      AMID  &LEN,1,1         AIF   "&IM"="#",.A&LOW     SETC  &LEN&HIGH    SETC  &LEN+1         AGO   .B.A&LOW     SETC  &LEN&LEN     AMID  &LEN,2,L:&LEN&HIGH    SETC  #>&LEN.B         LDA   &LOW         STA   WR2         LDA   &HIGH         STA   WR3         JSR   SYSFBUF         BCC   SYSA&SYSCNT         CLC         LDA   SYSESTMAX         STA   WR0         ADC   &LOW         STA   SYSESTMIN         STA   SYSESTE         LDA   SYSESTMAX+1         STA   WR1         ADC   &HIGH         STA   SYSESTMIN+1         STA   SYSESTE+1         LDA   &LOW         STA   WR2         LDA   &HIGH         STA   WR3         JSR   SYSRESVSYSA&SYSCNT ANOP         MEND         MACRO&LAB     INVERSE&LAB     LDA   #$3F         STA   $32         MEND         MACRO&LAB     LA    &AD1,&AD2,&R         LCLA  &LP         LCLC  &A&A       SETC  A         AIF   C:&R=0,.C1&A       SETC  &R.C1&LAB     LD&A  #<&AD2&LP      SETA  C:&AD1.C2         ST&A  &AD1(&LP)&LP      SETA  &LP-1         AIF   &LP>0,.C2         AIF   &AD2=0,.C2A         LD&A  #>&AD2.C2A&LP      SETA  C:&AD1.C3         ST&A  &AD1(&LP).+1&LP      SETA  &LP-1         AIF   &LP>0,.C3         MEND         MACRO&LAB     LM    &AD1,&AD2,&R         LCLC  &A         LCLA  &LP&A       SETC  A         AIF   C:&R=0,.LB1&A       SETC  &R.LB1&LAB     LD&A  &AD2&LP      SETA  C:&AD1.LB2         ST&A  &AD1(&LP)&LP      SETA  &LP-1         AIF   &LP<>0,.LB2         MEND         MACRO&LAB     MOVE  &AD1,&AD2,&LEN&LAB     ANOP         AIF   C:SYSESTE>0,.XXSYSESTE  EQU   $98.XX         LCLB  &IN         LCLB  &ST1         LCLB  &ST2         LCLB  &IM1         LCLC  &C         AIF   "&AD1"<>"*",.A&ST1     SETB  1&AD1     SETC  (SYSESTE)&IN      SETB  1         AGO   .C.A&C       AMID  "&AD1",1,1         AIF   "&C"<>"#",.B&IM1     SETB  1         AGO   .C.B         AIF   "&C"<>"{",.C&C       AMID  &AD1,L:&AD1,1         AIF   "&C"<>"}",.X&C       AMID  &AD1,2,L:&AD1-2&AD1     SETC  (&C)&IN      SETB  1.C         AIF   "&AD2"<>"*",.D&ST2     SETB  1&AD2     SETC  (SYSESTE)&IN      SETB  1         AGO   .E.D&C       AMID  &AD2,1,1         AIF   "&C"<>"{",.E&C       AMID  &AD2,L:&AD2,1         AIF   "&C"<>"}",.X&C       AMID  &AD2,2,L:&AD2-2&AD2     SETC  (&C)&IN      SETB  1.E         AIF   &IN,.I         AIF   C:&LEN=0,.G         AIF   &IM1,.F         LDX   &LENSYSA&SYSCNT LDA &AD1-1,X         STA   &AD2-1,X         DEX         BNE   SYSA&SYSCNT         MEXIT.F         LDX   &LEN         LDA   &AD1SYSA&SYSCNT STA &AD2-1,X         DEX         BNE   SYSA&SYSCNT         MEXIT.G         AIF   &IM1,.H         LDA   &AD1         STA   &AD2         LDA   &AD1+1         STA   &AD2+1         MEXIT.H         LDA   &AD1         STA   &AD2         STA   &AD2+1         MEXIT.I         AIF   &IM1,.R         AIF   .NOT.&ST2,.K         AIF   C:&LEN=0,.J         LDA   &LEN         JSR   SYSISTK         AGO   .K.J         LDA   #2         JSR   SYSISTK.K         AIF   C:&LEN=0,.N&C       AMID  &LEN,1,1         AIF   "&C"<>"#",.M&C       AMID  &LEN,2,L:&LEN-1         AIF   &C=1,.L         AIF   &C>129,.K1         LDY   &LEN-1SYSA&SYSCNT LDA &AD1,Y         STA   &AD2,Y         DEY         BPL   SYSA&SYSCNT         AGO   .O.K1         LDY   &LEN-1SYSA&SYSCNT LDA &AD1,Y         STA   &AD2,Y         DEY         BNE   SYSA&SYSCNT         LDA   &AD1,Y         STA   &AD2,Y         AGO   .O.L         LDY   #0         LDA   &AD1,Y         STA   &AD2,Y         AGO   .O.M         LDY   &LEN         DEY         BEQ   SYSB&SYSCNTSYSA&SYSCNT LDA &AD1,Y         STA   &AD2,Y         DEY         BNE   SYSA&SYSCNTSYSB&SYSCNT LDA &AD1,Y         STA   &AD2,Y         AGO   .O.N         LDY   #0         LDA   &AD1,Y         STA   &AD2,Y         INY         LDA   &AD1,Y         STA   &AD2,Y.O         AIF   .NOT.&ST1,.Q         AIF   C:&LEN=0,.P         LDA   &LEN         JSR   SYSDSTK         MEXIT.P         LDA   #2         JSR   SYSDSTK.Q         MEXIT.R         AIF   .NOT.&ST2,.R3         AIF   C:&LEN=0,.R1         LDA   &LEN         AGO   .R2.R1         LDA   #2.R2         JSR   SYSISTK.R3         LDA   &AD1         AIF   C:&LEN>0,.S         LDY   #1         AGO   .U.S&C       AMID  &LEN,1,1         AIF   "&C"<>"#",.T         LDY   &LEN-1         AGO   .U.T         LDY   &LEN         DEY.USYSA&SYSCNT STA &AD2,Y         DEY         BNE   SYSA&SYSCNT         STA   &AD2,Y         MEXIT.X         MNOTE "Missing '}'",16         MEND         MACRO&LAB     MOVEB &AD1,&AD2,&LEN         LCLC  &C         LCLC  &C1         LCLC  &C2         LCLC  &C3         LCLC  &B1         LCLC  &B2         LCLC  &B3         AIF   "&AD1"<>"*",.A&B1      SETC  011&C1      SETC  ANOP         AGO   .E.A&C       AMID  &AD1,1,1         AIF   "&C"<>"{",.C&C       AMID  &AD1,L:&AD1,1         AIF   "&C"<>"}",.P&AD1     AMID  &AD1,2,L:&AD1-2&B1      SETC  001         AGO   .D.C&B1      SETC  000.D&C1      SETC  "DC I'&AD1'".E         AIF   "&AD2"<>"*",.F&B2      SETC  011&C2      SETC  ANOP         AGO   .J.F&C       AMID  &AD2,1,1         AIF   "&C"<>"{",.H&C       AMID  &AD2,L:&AD2,1         AIF   "&C"<>"}",.P&AD2     AMID  &AD2,2,L:&AD2-2&B2      SETC  001         AGO   .I.H&B2      SETC  000.I&C2      SETC  "DC I'&AD2'".J         AIF   "&LEN"<>"*",.L&B3      SETC  011&C3      SETC  ANOP         AGO   .O.L&C       AMID  &LEN,1,1         AIF   "&C"<>"{",.M&C       AMID  &LEN,L:&LEN,1         AIF   "&C"<>"}",.P&LEN     AMID  &LEN,2,L:&LEN-2&B3      SETC  010         AGO   .N.M         AIF   "&C"<>"#",.M1&LEN     AMID  &LEN,2,L:&LEN&B3      SETC  000         AGO   .N.M1&B3      SETC  001.N&C3      SETC  "DC I'&LEN'".O&LAB     JSR   SYSMOVB         DC    B"&B1 &B2 &B3"         &C1         &C2         &C3         MEXIT.P         MNOTE "Missing closing '}'",16         MEND         MACRO&LAB     MOVEE &AD1,&AD2,&LEN         LCLC  &C         LCLC  &C1         LCLC  &C2         LCLC  &C3         LCLC  &B1         LCLC  &B2         LCLC  &B3         AIF   "&AD1"<>"*",.A&B1      SETC  011&C1      SETC  ANOP         AGO   .E.A&C       AMID  &AD1,1,1         AIF   "&C"<>"{",.C&C       AMID  &AD1,L:&AD1,1         AIF   "&C"<>"}",.P&AD1     AMID  &AD1,2,L:&AD1-2&B1      SETC  001         AGO   .D.C&B1      SETC  000.D&C1      SETC  "DC I'&AD1'".E         AIF   "&AD2"<>"*",.F&B2      SETC  011&C2      SETC  ANOP         AGO   .J.F&C       AMID  &AD2,1,1         AIF   "&C"<>"{",.H&C       AMID  &AD2,L:&AD2,1         AIF   "&C"<>"}",.P&AD2     AMID  &AD2,2,L:&AD2-2&B2      SETC  001         AGO   .I.H&B2      SETC  000.I&C2      SETC  "DC I'&AD2'".J         AIF   "&LEN"<>"*",.L&B3      SETC  011&C3      SETC  ANOP         AGO   .O.L&C       AMID  &LEN,1,1         AIF   "&C"<>"{",.M&C       AMID  &LEN,L:&LEN,1         AIF   "&C"<>"}",.P&LEN     AMID  &LEN,2,L:&LEN-2&B3      SETC  010         AGO   .N.M         AIF   "&C"<>"#",.M1&LEN     AMID  &LEN,2,L:&LEN&B3      SETC  000         AGO   .N.M1&B3      SETC  001.N&C3      SETC  "DC I'&LEN'".O&LAB     JSR   SYSMOVE         DC    B"&B1 &B2 &B3"         &C1         &C2         &C3         MEXIT.P         MNOTE "Missing closing '}'",16         MEND         MACRO&LAB     NORMAL&LAB     LDA   #$FF         STA   $32         MEND         MACRO&LAB     NOTE  &KEY,&TIME,&VOICE         AIF   C:MR0>0,.AMR0      EQU   $C8MR1      EQU   $C9MR2      EQU   $CAMR3      EQU   $CB.A&LAB     LDA   &KEY         STA   MR0         LDA   &TIME         STA   MR1         LDA   &VOICE         STA   MR2         JSR   SYSNOTE         MEND         MACRO&LAB     PAGE1&LAB     STA   $C054         MEND         MACRO&LAB     PAGE2&LAB     STA   $C055         MEND         MACRO&LAB     PREAD &PDL,&VAL&LAB     ANOP         LDX   &PDL         JSR   $FB1E         AIF   C:&VAL=0,.PVAL         STY   &VAL.PVAL         MEND         MACRO&LAB     RAM   &READ,&WRITE,&BANK         AIF   C:&READ>0,.L1         LCLC  &READ&READ    SETC  RAM.L1         AIF   C:&WRITE>0,.L2         LCLC  &WRITE&WRITE   SETC  ON.L2         AIF   C:&BANK>0,.L3         LCLC  &BANK&BANK    SETC  1.L3         AIF   "&READ"="RAM",.L5         AIF   "&WRITE"="ON",.L4&LAB     LDA   $C08A-(&BANK-1)*8         MEXIT.L4&LAB     LDA   $C089-(&BANK-1)*8         LDA   $C089-(&BANK-1)*8         MEXIT.L5         AIF   "&WRITE"="ON",.L6&LAB     LDA   $C088-(&BANK-1)*8         MEXIT.L6&LAB     LDA   $C08B-(&BANK-1)*8         LDA   $C08B-(&BANK-1)*8         MEND         MACRO&LAB     RESTORE&LAB     PLA         TAX         PLA         TAY         PLA         MEND         MACRO&LAB     SAVE&LAB     PHA         TYA         PHA         TXA         PHA         MEND         MACRO&LAB     SEED  &N1&LAB     DC    R"SYSRANX"         AIF   C:SYSESTE>0,.XXSYSESTE  EQU   $98.XX         AIF   C:&N1=0,.D         AIF   "&N1"="*",.C         LCLC  &C&C       AMID  &N1,1,1         AIF   "&C"="{",.A1         AIF   "&C"="#",.A         LDA   &N1         LDX   &N1+1         JSR   SYSRANX2         MEXIT.A&N1      AMID  &N1,2,L:&N1-1         LDA   #&N1         LDX   #>&N1         JSR   SYSRANX2         MEXIT.A1&C       AMID  &N1,L:&N1,1         AIF   "&C"="}",.B         MNOTE "Missing '}'",16         MEXIT.B&N1      AMID  &N1,2,L:&N1-2         LDY   #1         LDA   (&N1),Y         TAX         DEY         LDA   (&N1),Y         JSR   SYSRANX2         MEXIT.C         LDY   #1         LDA   (SYSESTE),Y         TAX         DEY         LDA   (SYSESTE),Y         TAY         CLC         LDA   SYSESTE         ADC   #2         STA   SYSESTE         BCC   SYSA&SYSCNT         INC   SYSESTE+1SYSA&SYSCNT TYA         JSR   SYSRANX2         MEXIT.D         LDA   $4E         LDX   $4F         JSR   SYSRANX2         MEND         MACRO&LAB     SOFTCALL &SUB&LAB     DC    H"20"         DC    S"&SUB"         MEND