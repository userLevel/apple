******************************************************************  SYSNOTE - Sound a Musical Note**  Plays the notes from the pianoforte keyboard in any of 4*  voices for durations specified in units of 1/16 second.**  By Mike Westerfield*  Copyright (C) June 1984, All rights reserved*  By the Byte Works, Inc.**  INPUTS:*        MR0 - voice, taken MOD 4*        MR1 - duration in a multiple of 1/16 sec, 1..64*        MR2 - Note to play, 1=A, 88=C, 0=pause******************************************************************         ALIGN 256SYSNOTE  STARTNOTEN    EQU   MR0                      note numberOCTAVE   EQU   MR0                      octave number (0..6)DUR      EQU   MR1                      durationVOICE    EQU   MR2                      voiceKEY      EQU   WR0                      note key number (0..11)SPAN     EQU   WR1                      span of tone maskSPAN2    EQU   WR2                      bit span for mask formationBMASK    EQU   WR3                      four byte bit mask areaSPEAKER  EQU   $C030                    Apple speakerTIME     EQU   SYSS1                    time counter;;  set up for note;         LDA   VOICE                    select voice mask         AND   #3         STA   VOICE         LDA   NOTEN         BNE   LB1         LM    VOICE,#4         BNE   LB2LB1      CMP   #89         BGE   ERR         ADC   #7         STA   NOTENLB2      LDA   DUR                      check duration         BEQ   ERR         CMP   #65         BLT   LB2AERR      LM    NOTEN,#64                Subrange ExceededLB2A     LDA   #0                       Take note number MOD 12 to separate         LDY   #8                        the octave from the note.LB3      ASL   NOTEN         ROL   A         SEC         SBC   #12         BCS   LB4         ADC   #12         DBNE  Y,LB3         BEQ   LB5LB4      INC   NOTEN         DBNE  Y,LB3LB5      STA   KEY         LDY   OCTAVE                   initialize the tone bit mask         CPY   #5         BGE   LB11         LDA   #0                       ... lower 5 octaves         STA   BMASK         STA   BMASK+1         STA   BMASK+2         STA   BMASK+3         LDX   #0         LDY   VOICE         LDA   VMASK,Y         STA   SPAN         LDA   #$80LB6      ASL   SPAN         BCC   LB7         STA   BMASK,XLB7      INX         CPX   #4         BNE   LB6         MOVE  #0,MASK,#64         LDX   OCTAVE         LDA   SPANS,X         STA   SPAN         LDX   #63         LM    SPAN2,#3LB8      LDY   SPAN2         LDA   BMASK,Y         STA   MASK,X         DBPL  SPAN2,LB9         LM    SPAN2,#3LB9      LDY   SPANLB10     DEX         DBPL  Y,LB10         INX         BPL   LB8         BMI   LB18LB11     BNE   LB12                     ... 5th octave         LDY   VOICE         LDA   VMASK,Y         STA   SPAN         LDA   #$08         ASL   SPAN         ASL   SPAN         ROL   A         MASL  A,3         STA   BMASK         LDA   #0         ASL   SPAN         ROR   A         STA   BMASK+1         BCC   LB16LB12     CPY   #7                       ... 6th octave         BEQ   LB14         LDY   VOICE         LDA   VMASK,Y         STA   SPAN         LDA   #0         LDX   #4LB13     ASL   SPAN         ROL   A         ASL   A         DBNE  X,LB13         BEQ   LB15LB14     LDY   VOICE                    ... 7th octave         LDA   VMASK,Y         MLSR  A,4         ORA   VMASK,YLB15     STA   BMASK         STA   BMASK+1LB16     LDX   #62LB17     LDA   BMASK         STA   MASK,X         LDA   BMASK+1         STA   MASK+1,X         DEX         DBPL  X,LB17LB18     LDA   KEY                      set the time counter and wait routine         ASL   A         TAX         LDA   TIMES,X         STA   SYSS1         LDA   TIMES+1,X         STA   SYSS1+1         LDA   WAITS,X         STA   JSR+1         LDA   WAITS+1,X         STA   JSR+2         LM    SYSS2,DUR         LM    SYSS2+1,#0         JSR   SYSMUL2         SUB2  #0,SYSS1,TIME;;  Play the note.  This section of code is extermely time critical.  It is;  so that each loop takes 61 cycles, no matter what particular path is choosen.;         JMP   PN1         ALIGN 256PN1      LDX   #63PN2      LDA   #1PN3      TAY         AND   MASK,X         BEQ   PN4         STA   SPEAKERPN4      BNE   PN5         STA   DUMMYPN5      TYAJSR      JSR   JSR         INC   TIME         BNE   PN6         INC   TIME+1         BNE   PN7         RTSPN6      CMP   TIME         CMP   DUMMYPN7      ASL   A         BNE   PN9         DEX         BNE   PN8         JMP   PN1PN8      NOP         JMP   PN2PN9      LDY   DUMMY         LDY   DUR         NOP         JMP   PN3;;  WAIT subroutines,Aone for each note.  These are planned for very specific;  delays.;WAITCS   ASL   DUR                      C#, 118 cycles         LDY   #10WT1      DBNE  Y,WT1         RTSWAITD    BIT   DUMMY                    D, 111 cycles         LDY   #9WT2      DBNE  Y,WT2         RTSWAITDS   BIT   DUR                      D#, 105 cycles         LDY   #8WT3      DBNE  Y,WT3         RTSWAITE    NOP                            E, 99 cycles         LDY   #7WT4      DBNE  Y,WT4         RTSWAITF    NOP                            F, 94 cycles         LDY   #6WT5      DBNE  Y,WT5         RTSWAITFS   ASL   DUMMY                    F#, 88 cycles         LDY   #4WT6      DBNE  Y,WT6         RTSWAITG    ASL   DUMMY                    G, 83 cycles         LDY   #3WT7      DBNE  Y,WT7         RTSWAITGS   NOP                            G#, 79 cycles         LDY   #3WT8      DBNE  Y,WT8         RTSWAITA    ASL   DUMMY                    A, 74 cycles         ASL   DUR         RTSWAITAS   ASL   DUR                      A#, 70 cycles         BIT   DUR         RTSWAITB    ASL   DUR                      B, 66 cycles         RTSWAITC    NOP                            C, 63 cycles         RTS;;  Tables;MASK     DS    64                       tone bit maskDUMMY    DS    1                        dummy speaker for timingWAITS    DC    A'WAITCS'         DC    A'WAITD'         DC    A'WAITDS'         DC    A'WAITE'         DC    A'WAITF'         DC    A'WAITFS'         DC    A'WAITG'         DC    A'WAITGS'         DC    A'WAITA'         DC    A'WAITAS'         DC    A'WAITB'         DC    A'WAITC'TIMES    DC    I'542'                   C#       2170         DC    I'575'                   D        2299         DC    I'609'                   D#       2435         DC    I'645'                   E        2580         DC    I'684'                   F        2734         DC    I'724'                   F#       2896         DC    I'767'                   G        3069         DC    I'813'                   G#       3251         DC    I'861'                   A        3444         DC    I'912'                   A#       3649         DC    I'967'                   B        3866         DC    I'1024'                  C        4096SPANS    DC    I1'16,8,4,2,1'VMASK    DC    B'1000 0000'         DC    B'1010 0000'         DC    B'1100 0000'         DC    B'1110 0000'         DC    B'0000 0000'         END