         LIST  OFF         SYMBOL OFF         MCOPY /RAM/FP.MACROS         KEEP  F.FLOAT         COPY  COMMON******************************************************************  SYSGETF - Get a Floating Point Number**  By Mike Westerfield*  Copyright (C) June 1984, All rights reserved*  By the Byte Works, Inc.**  OUTPUTS:*        SYSS1 - number read*        FERR - overflow and underflow errors are possible******************************************************************SYSGETF  START         USING SYSCOMRETURN   EQU   $0D                      RETURN key code         DC    R'SYSCOM';;  Initialization;         LDX   #0                       initialize the sign and current         STX   LSIGN                     character pointer         STX   EXP                      initialize the exponent         STX   EXP+1         DEX         STX   CC         LM    SYSS1,#FZERO             initialize the number;;  Read and save the sign.;RS0      JSR   SYSKBIN                  get the first character         LDX   SYSEOL         JNE   SS2         CMP   #' '         BEQ   RS0         CMP   #'-'                     flag the sign if it is a '-'         BNE   RS1         INC   LSIGN         BNE   MN1RS1      CMP   #'+'                     skip the sign if it is a '+'         BNE   MN2;;  Read and process the mantissa.;MN1      JSR   SYSKBIN                  process the characters before theMN2      JSR   SYSNMID                   decimal point         BCC   MN3         PHA         MOVE  TEN,SYSS2,#LUFP         LDX   #SYSS2         JSR   CEXP         JSR   SYSMULF         MOVE  SYSS1,SYSS2,#LUFP         PLA         AND   #$F         STA   SYSS1         LM    SYSS1+1,#0         JSR   SYSCV2F         JSR   SYSADDF         JMP   MN1MN3      CMP   #'.'                     check for a decimal point         BNE   EX1MN4      JSR   SYSKBIN                  process the characters after the         JSR   SYSNMID                   decimal point         BCC   EX1         PHA         MOVE  TEN,SYSS2,#LUFP         LDX   #SYSS2         JSR   CEXP         JSR   SYSMULF         MOVE  SYSS1,SYSS2,#LUFP         PLA         AND   #$F         STA   SYSS1         LM    SYSS1+1,#0         JSR   SYSCV2F         JSR   SYSADDF         DEC2  EXP         JMP   MN4;;  Read and process the exponent.;EX1      PHA                            move the number to a safe place         MOVE  SYSS1,TX1,#LUFP         PLA         CMP   #'E'                     check for exponent         BEQ   EX2         CMP   #'e'         BNE   EX3EX2      JSR   SYSGET2                  read the exponent value         ADD2  EXP,SYSS1EX3      LDA   EXP                      skip if exponent is zero         ORA   EXP+1         BNE   EX3B         MOVE  TX1,SYSS1,#LUFP         JMP   SS1EX3B     LDA   EXP+1                    decide on negative or positive         BPL   EX4                       exponent         SUB2  #0,EXP,EXP         LA    JAD,SYSDIVF         JMP   EX5EX4      LA    JAD,SYSMULFEX5      LDA   EXP+1         BNE   ERR         LDA   EXP         CMP   #40         BLT   EX6ERR      CMPW  JAD,#SYSDIVF         BEQ   ERR2         FERR  #FERR3         JMP   SS2ERR2     FERR  #FERR4         JMP   SS2EX6      STA   WR0                      do the exponent         MOVE  ONE,SYSS1,#LUFP         LDX   #SYSS1         JSR   CEXP         LA    WR2,E32         LM    WR1,#32EX7      SEC         LDA   WR0         SBC   WR1         BCC   EX8         STA   WR0         MOVE  {WR2},SYSS2,#LUFP         LDX   #SYSS2         JSR   CEXP         JSR   OPREX8      SUB2  WR2,#LUDP+2         LSR   WR1         BNE   EX7         MOVE  TX1,SYSS2,#LUFP         JSR   SYSMULF;;  Set the sign and pack.;SS1      ASL   SYSS1         LSR   LSIGN         ROR   SYSS1SS2      LDA   #<SYSS1         STA   MR0         STA   MR2         LDA   #>SYSS1         STA   MR1         STA   MR3         JMP   SYSPAKF;..............................................................;;                                                              ;;  Internal Subroutines and Data.                              ;;                                                              ;;..............................................................;;;  OPR - perform the operation whose address is at JAD;;OPR      JMP   (JAD);;  CEXP - convert exponent from double to single precision;CEXP     ASL   2,X         ASL   1,X         ROR   2,X         RTS;;  Local data area.;         DC    R'SYSSUBF'CC       DS    1                        current character pointerLSIGN    DS    1                        sign of numberJAD      DS    2                        operation addressEXP      DS    2                        exponent         END******************************************************************  SYSPUTF - Format a Single Precision Floating Point Number*        For Ouput**  Converts an unpacked floating point number into a formatted*  ASCII character string.**  By Mike Westerfield*  Copyright (C) June 1984, All rights reserved*  By the Byte Works, Inc.**  INPUTS:*        SYSS1 - sign and flags*        SYSE1 - exponent*        SYSM1 - mantissa*        SYSS2 - size of the output field*        SYSS2+2 - number of fraction digits to display******************************************************************SYSPUTF  START         USING SYSCOM         DC    R'SYSCOM';..............................................................;;                                                              ;;  Format the number                                           ;;                                                              ;;..............................................................;;;  Initialization;         LM    DECIMAL,SYSS2+2          save the input         LM    FORMAT,SYSS2             save the size of the output field         LM    CCHAR,#0                 initialize the string pointer         LDA   SYSS1                    output the sign         BPL   SC1         AND   #$7F         STA   SYSS1         LDA   #'-'         JSR   COUT;;  Handle infinity as a special case;SC1      LDA   SYSS1                    branch if not infinity         AND   #FINF         BEQ   ZR1         LDX   #0                       output an infinitySC2      LDA   INF,X         JSR   COUT         INX         CPX   #L:INF         BLT   SC2         JMP   WT1;;  Handle zero as a special case.;ZR1      LDA   SYSS1         AND   #FZERO         BEQ   FP1         STA   TX1         LDA   #0         STA   EXP         JMP   DD1;;  Find the largest power of 10 that is smaller than X.;FP1      LDX   #LUFP-1                  place numbers in starting positionsFP2      LDA   SYSS1,X         STA   SYSS2,X         STA   TX1,X         LDA   ONE,X         STA   SYSS1,X         DBPL  X,FP2         LDX   #SYSS1         JSR   CEXP         MOVE  SYSS1,TX2,#LUFP         LM    EXP,#0                   init for search         LM    LCNT,#7         LA    WR0,E32                  split on exponent         JSR   SYSCMPF         BGT   FP6FP3      MOVE  {WR0},SYSS2,#LUFP        search for EXP > 0         LDX   #SYSS2         JSR   CEXP         JSR   SYSMULF         MOVE  TX1,SYSS2,#LUFP         JSR   SYSCMPF         BLE   FP4         MOVE  TX2,SYSS1,#LUFP         JMP   FP5FP4      MOVE  SYSS1,TX2,#LUFP         CLC         LDY   #LUDP         LDA   EXP         ADC   (WR0),Y         STA   EXPFP5      SUB2  WR0,#LUDP+2         DBNE  LCNT,FP3         BEQ   DD1FP6      MOVE  {WR0},SYSS2,#LUFP        search for EXP < 0         LDX   #SYSS2         JSR   CEXP         JSR   SYSDIVF         MOVE  TX1,SYSS2,#LUFP         JSR   SYSCMPF         BGE   FP7         MOVE  TX2,SYSS1,#LUFP         JMP   FP8FP7      MOVE  SYSS1,TX2,#LUFP         SEC         LDA   EXP         LDY   #LUDP         SBC   (WR0),Y         STA   EXPFP8      SUB2  WR0,#LUDP+2         DBNE  LCNT,FP6;;  Strip off the 7 most significant decimal digits;DD1      LDX   #LUFP-1                  normalize the numberDD2      LDA   SYSS1,X         STA   SYSS2,X         LDA   TX1,X         STA   SYSS1,X         DBPL  X,DD2         JSR   SYSDIVF         LDA   SYSE1+1                  correct numbers < 1         CMP   #$7F         BGE   DD2A         DEC   EXP         MOVE  TEN,SYSS2,#LUFP         LDX   #SYSS2         JSR   CEXP         JSR   SYSMULFDD2A     MOVE  #'0',TX1,#8              strip off the digits         BIT   SYSS1         BVS   WM1         LM    LCNT,#0DD3      LDA   #0DD3A     LDX   SYSE1+1         CPX   #$7F         BLT   DD4         CLC         JSR   SYSROLF2         ROL   A         DEC   SYSE1+1         BNE   DD3A         BEQ   DD7DD4      ORA   #'0'         LDX   LCNT         STA   TX1,X         INX         CPX   #8         BEQ   DD7         STX   LCNTDD5      LDA   SYSM1         BMI   DD6         CLC         JSR   SYSROLF2         DEC   SYSE1+1         BNE   DD5         BEQ   DD7DD6      MOVE  TEN,SYSS2,#LUFP         LDX   #SYSS2         JSR   CEXP         JSR   SYSMULF         JMP   DD3DD7      LDA   TX1+7                    round         CMP   #'5'         BLT   WM1         LDX   #6DD8      INC   TX1,X         LDA   TX1,X         CMP   #'9'+1         BNE   WM1         LDA   #'0'         STA   TX1,X         DBPL  X,DD8         LM    TX1,#'1'         INC   EXP;;  Write out the mantissa;WM1      LM    EFLAG,#0                 initialize the exponent flag         LDA   DECIMAL                  split on exponent type         BEQ   WM2         LDA   EXP         BMI   WM4         CMP   #7         BLT   WM3WM2      LM    DECIMAL,#6               standard scientific notation         LM    (DIGIT,EFLAG),#1         BNE   WM6WM3      STA   DIGIT                    fixed point, > 1         INC   DIGIT         BNE   WM6WM4      LM    DIGIT,#0                 fixed point, < 1         INC   EXPWM6      LDX   #0                       write out digits         LDA   DIGIT         BEQ   WM8WM7      LDA   TX1,X         JSR   COUT         INX         DBNE  DIGIT,WM7         BEQ   WM9WM8      LDA   #'0'         JSR   COUTWM9      LDA   DECIMAL                  write out decimal fraction         BEQ   EX1         LDA   #'.'         JSR   COUT         LDA   EFLAG         BNE   WM11WM10     LDA   EXP         BPL   WM11         LDA   #'0'         JSR   COUT         INC   EXP         DBNE  DECIMAL,WM10         BEQ   EX1WM11     CPX   #7         BGE   WM12         LDA   TX1,X         JSR   COUT         INX         DBNE  DECIMAL,WM11         BEQ   EX1WM12     LDA   #' '         JSR   COUT         DBNE  DECIMAL,WM12;;  Write out the exponent;EX1      LDA   EFLAG                    skip if fixed point         BEQ   WT1         LDA   #' '                     write the header         JSR   COUT         LDA   #'E'         JSR   COUT         LDA   #' '                     write the sign         LDX   EXP         BPL   EX2         SEC         LDA   #0         SBC   EXP         STA   EXP         LDA   #'-'EX2      JSR   COUT         LM    SYSS1,EXP                write the exponent         LM    SYSS2,#10         LM    (SYSS1+1,SYSS2+1),#0         JSR   SYSDIV2         LDA   SYSS1         ORA   #'0'         JSR   COUT         LDA   SYSS1+2         ORA   #'0'         JSR   COUT;;  Write the string to the output device.;WT1      SEC                            write leading blanks needed to right         LDA   FORMAT                    justify in the output field         SBC   CCHAR         BCC   WT2         TAX         JSR   SYSPRBLWT2      LDY   #1                       write the numberWT3      LDA   SYSLINE,Y         JSR   SYSCOUT         INY         DBNE  CCHAR,WT3         RTS;..............................................................;;                                                              ;;  COUT - Output a character to the number string              ;;                                                              ;;..............................................................;;COUT     STX   TX         LDX   CCHAR         STA   SYSLINE+1,X         INC   CCHAR         BNE   CT1         DEC   CCHARCT1      LDX   TX         RTS;..............................................................;;                                                              ;;  CEXP - Compress a Double exponent into a Real exponent.     ;;                                                              ;;..............................................................;;CEXP     ASL   $2,X         ASL   $1,X         ROR   $2,X         RTS;..............................................................;;                                                              ;;  Data area                                                   ;;                                                              ;;..............................................................;;CCHAR    DS    1                        current character pointerDECIMAL  DS    1                        number of fraction digits to outputDIGIT    DS    1                        number of digits to outputEFLAG    DS    1                        exponent flagEXP      DS    1                        decimal exponentFORMAT   DS    1                        size of the output fieldINF      DC    C'infinity'LCNT     DS    1                        loop counterTX       DS    1                        temp X register         DC    R'SYSUNPF'         END         APPEND FP.1