 MACRO&LAB DEBUG &C&LAB ANOP AIF .NOT.DEBUG,.A JSR STRCE DC C'&C' AIF L:&C=10,.A LCLA &CNT&CNT SETA 10-L:&C DC &CNT.C' '.A MEND MACRO&LAB GETS &N1,&CR AIF C:&CR>0,.A LCLC &CR.A&LAB GETX &N1,&CR,S,1010 MEND MACRO&LAB GETX &N1,&CR,&T,&BT LCLC &C LCLC &C1 LCLC &B1 AIF "&N1"<>"*",.A&B1 SETC 11&C1 SETC ANOP AGO .D.A&C AMID &N1,1,1 AIF "&C"<>"{",.B&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.F&N1 AMID &N1,2,L:&N1-2&B1 SETC 10 AGO .C.B&B1 SETC 01.C&C1 SETC "DC I'&N1'".D&LAB JSR SYSREAD DC A"SYSGET&T"&C SETC 00 AIF C:&CR=0,.E&C SETC 01.E DC B"&BT &C &B1" &C1 MEXIT.F MNOTE "Missing closing '}'",16 MEND MACRO&LAB HOME&LAB LDA #$0C JSR SYSCOUT MEND MACRO&LAB PRBL &AD1&LAB LDX &AD1 JSR SYSPRBL MEND MACRO&LAB PUTS &N1,&F1,&CR AIF C:&F1>0,.A LCLC &F1.A AIF C:&CR>0,.C LCLC &CR.C&LAB PUTX "&N1",&F1,&CR,S,1010,C MEND MACRO&LAB PUTC &N1,&F1,&CR AIF C:&F1>0,.A LCLC &F1.A AIF C:&CR>0,.C LCLC &CR.C&LAB PUTX "&N1",&F1,&CR,C,1001,C MEND MACRO&LAB PUTX &N1,&F1,&CR,&T,&BP,&DC LCLC &C LCLC &C1 LCLC &C2 LCLC &B1 LCLC &B2 AIF L:&N1>1,.A AIF "&N1"<>"*",.A&B1 SETC 11&C1 SETC ANOP AGO .E.A&C AMID "&N1",1,1 AIF "&C"<>"#",.B&B1 SETC 00&N1 AMID "&N1",2,L:&N1-1 AIF ("&DC"="C"),.A1&C1 SETC "DC &DC'&N1'" AGO .E.A1&C1 SETC "DC &DC.&N1" AGO .E.B AIF "&C"<>"{",.C&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.X&N1 AMID &N1,2,L:&N1-2&B1 SETC 10 AGO .D.C&B1 SETC 01.D&C1 SETC "DC I'&N1'".E AIF C:&F1>0,.F&B2 SETC 00&C2 SETC "DC I'0'" AGO .J.F AIF "&F1"<>"*",.G&B2 SETC 11&C2 SETC ANOP AGO .J.G&C AMID &F1,1,1 AIF "&C"<>"#",.G1&B2 SETC 00&F1 AMID &F1,2,L:&F1-1&C2 SETC "DC I'&F1'" AGO .J.G1 AIF "&C"<>"{",.H&C AMID &F1,L:&F1,1 AIF "&C"<>"}",.X&F1 AMID &F1,2,L:&F1-2&B2 SETC 10 AGO .I.H&B2 SETC 01.I&C2 SETC "DC I'&F1'".J&LAB JSR SYSRITE DC A"SYSPUT&T"&C SETC 00 AIF C:&CR=0,.K&C SETC 01.K DC B"&BP &C &B1" DC B"&B2 000000" AIF .NOT.(("&B1"="00").AND.("&T"="S")),.L DC I1"L:SYSA&SYSCNT" DC I1"L:SYSA&SYSCNT".LSYSA&SYSCNT &C1 &C2 MEXIT.X MNOTE "Missing closing '}'",16 MEND MACRO&LAB PUTCR &DCB&LAB LDA #$0D JSR SYSCOUT MEND MACRO&LAB ADD2 &N1,&N2,&N3&LAB ANOP AIF C:SYSESTE>0,.XXSYSESTE EQU $98.XX LCLB &IM1 LCLB &IM2 LCLB &IN1 LCLB &IN2 LCLB &IN3 LCLB &IN LCLB &ST1 LCLB &ST2 LCLB &ST3 LCLC &C LCLC &N12 LCLC &N22 LCLC &N32 AIF "&N1"<>"*",.A&IN1 SETB 1&IN SETB 1&ST1 SETB 1&N1 SETC "(SYSESTE),Y"&N12 SETC "(SYSESTE),Y" AGO .D.A&C AMID &N1,1,1 AIF "&C"<>"#",.B&IM1 SETB 1&N12 AMID &N1,2,L:&N1-1&N12 SETC #>&N12 AGO .D.B AIF "&C"<>"{",.C&IN1 SETB 1&IN SETB 1&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.Y&N1 AMID &N1,2,L:&N1-2&N12 SETC "(&N1),Y"&N1 SETC "(&N1),Y" AGO .D.C&N12 SETC &N1+1.D AIF "&N2"<>"*",.E&IN2 SETB 1&IN SETB 1&ST2 SETB 1&N2 SETC "(SYSESTE),Y"&N22 SETC "(SYSESTE),Y" AGO .H.E&C AMID &N2,1,1 AIF "&C"<>"#",.F&IM2 SETB 1&N22 AMID &N2,2,L:&N2-1&N22 SETC #>&N22 AGO .H.F AIF "&C"<>"{",.G&IN2 SETB 1&IN SETB 1&C AMID &N2,L:&N2,1 AIF "&C"<>"}",.Y&N2 AMID &N2,2,L:&N2-2&N22 SETC "(&N2),Y"&N2 SETC "(&N2),Y" AGO .H.G&N22 SETC &N2+1.H AIF C:&N3>0,.I AIF .NOT.&IM2..OR.&IN,.H1&C AMID &N2,2,L:&N2-1 AIF &C<256,.V.H1 LCLC &N3&N3 SETC "&N1"&N32 SETC "&N12"&IN3 SETB &IN1&ST3 SETB &ST1 AIF .NOT.&IM1,.L MNOTE "Must specify destination",16 MEXIT.I AIF "&N3"<>"*",.J&IN3 SETB 1&IN SETB 1&ST3 SETB 1&N3 SETC "(SYSESTE),Y"&N32 SETC "(SYSESTE),Y" AGO .L.J&C AMID &N3,1,1 AIF "&C"<>"{",.K&IN3 SETB 1&IN SETB 1&C AMID &N3,L:&N3,1 AIF "&C"<>"}",.Y&N3 AMID &N3,2,L:&N3-2&N32 SETC "(&N3),Y"&N3 SETC "(&N3),Y" AGO .L.K&N32 SETC &N3+1.L AIF &ST1..AND.&ST2,.Q AIF &ST1+&ST2>=&ST3,.M SEC LDA SYSESTE SBC #2 STA SYSESTE BCS SYSA&SYSCNT DEC SYSESTE+1SYSA&SYSCNT ANOP.M CLC AIF .NOT.&IN,.N LDY #0.N LDA &N1 ADC &N2 STA &N3 AIF .NOT.&IN,.O INY.O LDA &N12 ADC &N22 STA &N32 AIF &ST1+&ST2<=&ST3,.P CLC LDA SYSESTE ADC #2 STA SYSESTE BCC SYSB&SYSCNT INC SYSESTE+1SYSB&SYSCNT ANOP.P MEXIT.Q AIF &IN3..AND..NOT.&ST3,.R CLC LDY #0 LDA &N1 LDY #2 ADC &N2 STA &N3 DEY LDA &N12 LDY #3 ADC &N22 STA &N32 AGO .S.R CLC LDY #2 LDA &N1 LDY #0 ADC &N2 STA &N3 LDY #3 LDA &N12 LDY #1 ADC &N22 STA &N32.S CLC LDA SYSESTE AIF &ST3,.T ADC #4 AGO .U.T ADC #2.U STA SYSESTE BCC SYSC&SYSCNT INC SYSESTE+1SYSC&SYSCNT ANOP MEXIT.V CLC AIF .NOT.&IN,.W LDY #0.W LDA &N1 ADC &N2 STA &N1 BCC SYSD&SYSCNT AIF .NOT.&IN,.X INY.X INC &N1+1SYSD&SYSCNT ANOP MEXIT.Y MNOTE "Missing closing '}'",16 MEND MACRO&LAB MUL2 &N1,&N2,&N3 LCLC &C LCLC &C1 LCLC &C2 LCLC &C3 LCLC &B1 LCLC &B2 LCLC &B3 LCLB &ST1 AIF "&N1"<>"*",.A&B1 SETC 011&ST1 SETB 1&C1 SETC ANOP AGO .E.A&C AMID &N1,1,1 AIF "&C"<>"#",.B&B1 SETC 000&N1 AMID &N1,2,L:&N1-1 AGO .D.B AIF "&C"<>"{",.C&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.P&N1 AMID &N1,2,L:&N1-2&B1 SETC 010 AGO .D.C&B1 SETC 001.D&C1 SETC "DC I'&N1'".E AIF "&N2"<>"*",.F&B2 SETC 011&C2 SETC ANOP AGO .J.F&C AMID &N2,1,1 AIF "&C"<>"#",.G&B2 SETC 000&N2 AMID &N2,2,L:&N2-1 AGO .I.G AIF "&C"<>"{",.H&C AMID &N2,L:&N2,1 AIF "&C"<>"}",.P&N2 AMID &N2,2,L:&N2-2&B2 SETC 010 AGO .I.H&B2 SETC 001.I&C2 SETC "DC I'&N2'".J AIF C:&N3>0,.K&B3 SETC &B1 AIF &ST1,.J1&C3 SETC "DC I'&N1'" AGO .O.J1&C3 SETC ANOP AGO .O.K AIF "&N3"<>"*",.L&B3 SETC 011&C3 SETC ANOP AGO .O.L&C AMID &N3,1,1 AIF "&C"<>"{",.M&C AMID &N3,L:&N3,1 AIF "&C"<>"}",.P&N3 AMID &N3,2,L:&N3-2&B3 SETC 010 AGO .N.M&B3 SETC 001.N&C3 SETC "DC I'&N3'".O&LAB JSR SYSBOPR DC A"SYSMUL2" DC B"000 &B1 000 &B2 &B3" &C1 &C2 &C3 MEXIT.P MNOTE "Missing closing '}'",16 MEND MACRO&LAB SUB2 &N1,&N2,&N3&LAB ANOP AIF C:SYSESTE>0,.XXSYSESTE EQU $98.XX LCLB &IM1 LCLB &IM2 LCLB &IN1 LCLB &IN2 LCLB &IN3 LCLB &IN LCLB &ST1 LCLB &ST2 LCLB &ST3 LCLC &C LCLC &N12 LCLC &N22 LCLC &N32 AIF "&N1"<>"*",.A&IN1 SETB 1&IN SETB 1&ST1 SETB 1&N1 SETC "(SYSESTE),Y"&N12 SETC "(SYSESTE),Y" AGO .D.A&C AMID &N1,1,1 AIF "&C"<>"#",.B&IM1 SETB 1&N12 AMID &N1,2,L:&N1-1&N12 SETC #>&N12 AGO .D.B AIF "&C"<>"{",.C&IN1 SETB 1&IN SETB 1&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.Y&N1 AMID &N1,2,L:&N1-2&N12 SETC "(&N1),Y"&N1 SETC "(&N1),Y" AGO .D.C&N12 SETC &N1+1.D AIF "&N2"<>"*",.E&IN2 SETB 1&IN SETB 1&ST2 SETB 1&N2 SETC "(SYSESTE),Y"&N22 SETC "(SYSESTE),Y" AGO .H.E&C AMID &N2,1,1 AIF "&C"<>"#",.F&IM2 SETB 1&N22 AMID &N2,2,L:&N2-1&N22 SETC #>&N22 AGO .H.F AIF "&C"<>"{",.G&IN2 SETB 1&IN SETB 1&C AMID &N2,L:&N2,1 AIF "&C"<>"}",.Y&N2 AMID &N2,2,L:&N2-2&N22 SETC "(&N2),Y"&N2 SETC "(&N2),Y" AGO .H.G&N22 SETC &N2+1.H AIF C:&N3>0,.I AIF .NOT.&IM2..OR.&IN,.H1&C AMID &N2,2,L:&N2-1 AIF &C<256,.V.H1 LCLC &N3&N3 SETC "&N1"&N32 SETC "&N12"&IN3 SETB &IN1&ST3 SETB &ST1 AIF .NOT.&IM1,.L MNOTE "Must specify destination",16 MEXIT.I AIF "&N3"<>"*",.J&IN3 SETB 1&IN SETB 1&ST3 SETB 1&N3 SETC "(SYSESTE),Y"&N32 SETC "(SYSESTE),Y" AGO .L.J&C AMID &N3,1,1 AIF "&C"<>"{",.K&IN3 SETB 1&IN SETB 1&C AMID &N3,L:&N3,1 AIF "&C"<>"}",.Y&N3 AMID &N3,2,L:&N3-2&N32 SETC "(&N3),Y"&N3 SETC "(&N3),Y" AGO .L.K&N32 SETC &N3+1.L AIF &ST1..AND.&ST2,.Q AIF &ST1+&ST2>=&ST3,.M SEC LDA SYSESTE SBC #2 STA SYSESTE BCS SYSA&SYSCNT DEC SYSESTE+1SYSA&SYSCNT ANOP.M SEC AIF .NOT.&IN,.N LDY #0.N LDA &N1 SBC &N2 STA &N3 AIF .NOT.&IN,.O INY.O LDA &N12 SBC &N22 STA &N32 AIF &ST1+&ST2<=&ST3,.P CLC LDA SYSESTE ADC #2 STA SYSESTE BCC SYSB&SYSCNT INC SYSESTE+1SYSB&SYSCNT ANOP.P MEXIT.Q AIF .NOT.&ST3,.R SEC LDY #2 LDA &N1 LDY #0 SBC &N2 LDY #2 STA &N3 INY LDA &N12 LDY #1 SBC &N22 LDY #3 STA &N32 AGO .S.R SEC LDY #2 LDA &N1 LDY #0 SBC &N2 STA &N3 LDY #3 LDA &N12 LDY #1 SBC &N22 STA &N32.S CLC LDA SYSESTE AIF &ST3,.T ADC #4 AGO .U.T ADC #2.U STA SYSESTE BCC SYSC&SYSCNT INC SYSESTE+1SYSC&SYSCNT ANOP MEXIT.V SEC AIF .NOT.&IN,.W LDY #0.W LDA &N1 SBC &N2 STA &N1 BCS SYSD&SYSCNT AIF .NOT.&IN,.X INY.X DEC &N1+1SYSD&SYSCNT ANOP MEXIT.Y MNOTE "Missing closing '}'",16 MEND MACRO&LAB CMPW &N1,&N2&LAB ANOP AIF C:SYSESTE>0,.XXSYSESTE EQU $98.XX LCLB &IM1 LCLB &IM2 LCLB &IN1 LCLB &IN2 LCLB &IN LCLB &ST1 LCLB &ST2 LCLC &C LCLC &N12 LCLC &N22 AIF "&N1"<>"*",.A&IN1 SETB 1&IN SETB 1&ST1 SETB 1&N1 SETC "(SYSESTE),Y"&N12 SETC "(SYSESTE),Y" AGO .D.A&C AMID &N1,1,1 AIF "&C"<>"#",.B&IM1 SETB 1&N12 AMID &N1,2,L:&N1-1&N12 SETC #>&N12 AGO .D.B AIF "&C"<>"{",.C&IN1 SETB 1&IN SETB 1&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.Y&N1 AMID &N1,2,L:&N1-2&N12 SETC "(&N1),Y"&N1 SETC "(&N1),Y" AGO .D.C&N12 SETC &N1+1.D AIF "&N2"<>"*",.E&IN2 SETB 1&IN SETB 1&ST2 SETB 1&N2 SETC "(SYSESTE),Y"&N22 SETC "(SYSESTE),Y" AGO .H.E&C AMID &N2,1,1 AIF "&C"<>"#",.F&IM2 SETB 1&N22 AMID &N2,2,L:&N2-1&N22 SETC #>&N22 AGO .H.F AIF "&C"<>"{",.G&IN2 SETB 1&IN SETB 1&C AMID &N2,L:&N2,1 AIF "&C"<>"}",.Y&N2 AMID &N2,2,L:&N2-2&N22 SETC "(&N2),Y"&N2 SETC "(&N2),Y" AGO .H.G&N22 SETC &N2+1.H AIF .NOT.&IM2,.I&C AMID &N2,2,L:&N2-1 AIF &C=0,.V.I AIF &ST1..AND.&ST2,.Q AIF .NOT.&IN,.N LDY #1.N LDA &N12 CMP &N22 BNE SYSA&SYSCNT AIF .NOT.&IN,.O DEY.O LDA &N1 CMP &N2SYSA&SYSCNT ANOP AIF .NOT.(&ST1..OR.&ST2),.P PHP CLC LDA SYSESTE ADC #2 STA SYSESTE BCC SYSB&SYSCNT INC SYSESTE+1SYSB&SYSCNT PLP.P MEXIT.Q LDY #3 LDA &N12 LDY #1 CMP &N22 BNE SYSB&SYSCNT LDY #2 LDA &N1 LDY #0 CMP &N2SYSB&SYSCNT ANOP PHP CLC LDA SYSESTE ADC #4 STA SYSESTE BCC SYSC&SYSCNT INC SYSESTE+1SYSC&SYSCNT PLP MEXIT.V SEC AIF .NOT.&IN,.W LDY #0.W LDA &N1 AIF .NOT.&IN,.X INY.X ORA &N12 AIF .NOT.&ST1,.X1 PHP CLC LDA SYSESTE ADC #2 STA SYSESTE BCC SYSC&SYSCNT INC SYSESTE+1SYSC&SYSCNT PLP.X1 MEXIT.Y MNOTE "Missing closing '}'",16 MEND MACRO&LAB DBNE &R,&BP AIF "&R"="X",.L1 AIF "&R"="Y",.L1&LAB DEC &R BNE &BP MEXIT.L1&LAB DE&R BNE &BP MEND MACRO&LAB DBPL &R,&BP AIF "&R"="X",.L1 AIF "&R"="Y",.L1&LAB DEC &R BPL &BP MEXIT.L1&LAB DE&R BPL &BP MEND MACRO&LAB INC2 &N1 LCLC &C LCLC &C1 LCLC &B1 AIF "&N1"<>"*",.A&N1 SETC SYSESTE AGO .A1.A&C AMID &N1,1,1 AIF "&C"<>"{",.B&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.C&N1 AMID &N1,2,L:&N1-2.A1&LAB LDY #0 CLC LDA (&N1),Y ADC #1 STA (&N1),Y INY LDA (&N1),Y ADC #0 STA (&N1),Y MEXIT.B&LAB INC &N1 BNE SYSI&SYSCNT INC &N1+1SYSI&SYSCNT ANOP MEXIT.C MNOTE "Missing closing '}'",16 MEND MACRO&LAB JCC &BP&LAB BCS *+5 JMP &BP MEND MACRO&LAB JEQ &BP&LAB BNE *+5 JMP &BP MEND MACRO&LAB JMI &BP&LAB BPL *+5 JMP &BP MEND MACRO&LAB JNE &BP&LAB BEQ *+5 JMP &BP MEND MACRO&LAB MLSR &ADR,&NUM&LAB ANOP LCLA &NM&NM SETA &NUM.TOP LSR &ADR&NM SETA &NM-1 AIF &NM>0,.TOP MEND MACRO&LAB DSTR &ADR,&LENGTH AIF C:&LENGTH=0,.C AIF C:&ADR=0,.B LCLA &N&N SETA &LENGTH AIF &N>=L:&ADR,.A&N SETA L:&ADR.A&LAB DC I1"&N" DC I1"L:SYSA&SYSCNT"SYSA&SYSCNT DC C"&ADR" DS &N-L:SYSA&SYSCNT MEXIT.B&LAB DC I1"&LENGTH" DC I1"0" DS &LENGTH MEXIT.C&LAB DC I1"L:SYSA&SYSCNT" DC I1"L:SYSA&SYSCNT"SYSA&SYSCNT DC C"&ADR" MEND MACRO&LAB DW &ADR&LAB DC I1"L:SYSA&SYSCNT"SYSA&SYSCNT DC C"&ADR" MEND MACRO&LAB INITSTACK &LEN AIF C:SYSESTE>0,.XXSYSESTE EQU $98.XX LCLC &IM LCLC &LOW LCLC &HIGH&LAB LDA #SYSESTMAX STA WR0 LDA #>SYSESTMAX STA WR1&IM AMID &LEN,1,1 AIF "&IM"="#",.A&LOW SETC &LEN&HIGH SETC &LEN+1 AGO .B.A&LOW SETC &LEN&LEN AMID &LEN,2,L:&LEN&HIGH SETC #>&LEN.B LDA &LOW STA WR2 LDA &HIGH STA WR3 JSR SYSFBUF BCC SYSA&SYSCNT CLC LDA SYSESTMAX STA WR0 ADC &LOW STA SYSESTMIN STA SYSESTE LDA SYSESTMAX+1 STA WR1 ADC &HIGH STA SYSESTMIN+1 STA SYSESTE+1 LDA &LOW STA WR2 LDA &HIGH STA WR3 JSR SYSRESVSYSA&SYSCNT ANOP MEND MACRO&LAB LA &AD1,&AD2,&R LCLA &LP LCLC &A&A SETC A AIF C:&R=0,.C1&A SETC &R.C1&LAB LD&A #<&AD2&LP SETA C:&AD1.C2 ST&A &AD1(&LP)&LP SETA &LP-1 AIF &LP>0,.C2 AIF &AD2=0,.C2A LD&A #>&AD2.C2A&LP SETA C:&AD1.C3 ST&A &AD1(&LP).+1&LP SETA &LP-1 AIF &LP>0,.C3 MEND MACRO&LAB LM &AD1,&AD2,&R LCLC &A LCLA &LP&A SETC A AIF C:&R=0,.LB1&A SETC &R.LB1&LAB LD&A &AD2&LP SETA C:&AD1.LB2 ST&A &AD1(&LP)&LP SETA &LP-1 AIF &LP<>0,.LB2 MEND MACRO&LAB MOVE &AD1,&AD2,&LEN&LAB ANOP AIF C:SYSESTE>0,.XXSYSESTE EQU $98.XX LCLB &IN LCLB &ST1 LCLB &ST2 LCLB &IM1 LCLC &C AIF "&AD1"<>"*",.A&ST1 SETB 1&AD1 SETC (SYSESTE)&IN SETB 1 AGO .C.A&C AMID "&AD1",1,1 AIF "&C"<>"#",.B&IM1 SETB 1 AGO .C.B AIF "&C"<>"{",.C&C AMID &AD1,L:&AD1,1 AIF "&C"<>"}",.X&C AMID &AD1,2,L:&AD1-2&AD1 SETC (&C)&IN SETB 1.C AIF "&AD2"<>"*",.D&ST2 SETB 1&AD2 SETC (SYSESTE)&IN SETB 1 AGO .E.D&C AMID &AD2,1,1 AIF "&C"<>"{",.E&C AMID &AD2,L:&AD2,1 AIF "&C"<>"}",.X&C AMID &AD2,2,L:&AD2-2&AD2 SETC (&C)&IN SETB 1.E AIF &IN,.I AIF C:&LEN=0,.G AIF &IM1,.F LDX &LENSYSA&SYSCNT LDA &AD1-1,X STA &AD2-1,X DEX BNE SYSA&SYSCNT MEXIT.F LDX &LEN LDA &AD1SYSA&SYSCNT STA &AD2-1,X DEX BNE SYSA&SYSCNT MEXIT.G AIF &IM1,.H LDA &AD1 STA &AD2 LDA &AD1+1 STA &AD2+1 MEXIT.H LDA &AD1 STA &AD2 STA &AD2+1 MEXIT.I AIF &IM1,.R AIF .NOT.&ST2,.K AIF C:&LEN=0,.J LDA &LEN JSR SYSISTK AGO .K.J LDA #2 JSR SYSISTK.K AIF C:&LEN=0,.N&C AMID &LEN,1,1 AIF "&C"<>"#",.M&C AMID &LEN,2,L:&LEN-1 AIF &C=1,.L AIF &C>129,.K1 LDY &LEN-1SYSA&SYSCNT LDA &AD1,Y STA &AD2,Y DEY BPL SYSA&SYSCNT AGO .O.K1 LDY &LEN-1SYSA&SYSCNT LDA &AD1,Y STA &AD2,Y DEY BNE SYSA&SYSCNT LDA &AD1,Y STA &AD2,Y AGO .O.L LDY #0 LDA &AD1,Y STA &AD2,Y AGO .O.M LDY &LEN DEY BEQ SYSB&SYSCNTSYSA&SYSCNT LDA &AD1,Y STA &AD2,Y DEY BNE SYSA&SYSCNTSYSB&SYSCNT LDA &AD1,Y STA &AD2,Y AGO .O.N LDY #0 LDA &AD1,Y STA &AD2,Y INY LDA &AD1,Y STA &AD2,Y.O AIF .NOT.&ST1,.Q AIF C:&LEN=0,.P LDA &LEN JSR SYSDSTK MEXIT.P LDA #2 JSR SYSDSTK.Q MEXIT.R AIF .NOT.&ST2,.R3 AIF C:&LEN=0,.R1 LDA &LEN AGO .R2.R1 LDA #2.R2 JSR SYSISTK.R3 LDA &AD1 AIF C:&LEN>0,.S LDY #1 AGO .U.S&C AMID &LEN,1,1 AIF "&C"<>"#",.T LDY &LEN-1 AGO .U.T LDY &LEN DEY.USYSA&SYSCNT STA &AD2,Y DEY BNE SYSA&SYSCNT STA &AD2,Y MEXIT.X MNOTE "Missing '}'",16 MEND MACRO&LAB SEED &N1&LAB DC R"SYSRANX" AIF C:SYSESTE>0,.XXSYSESTE EQU $98.XX AIF C:&N1=0,.D AIF "&N1"="*",.C LCLC &C&C AMID &N1,1,1 AIF "&C"="{",.A1 AIF "&C"="#",.A LDA &N1 LDX &N1+1 JSR SYSRANX2 MEXIT.A&N1 AMID &N1,2,L:&N1-1 LDA #&N1 LDX #>&N1 JSR SYSRANX2 MEXIT.A1&C AMID &N1,L:&N1,1 AIF "&C"="}",.B MNOTE "Missing '}'",16 MEXIT.B&N1 AMID &N1,2,L:&N1-2 LDY #1 LDA (&N1),Y TAX DEY LDA (&N1),Y JSR SYSRANX2 MEXIT.C LDY #1 LDA (SYSESTE),Y TAX DEY LDA (SYSESTE),Y TAY CLC LDA SYSESTE ADC #2 STA SYSESTE BCC SYSA&SYSCNT INC SYSESTE+1SYSA&SYSCNT TYA JSR SYSRANX2 MEXIT.D LDA $4E LDX $4F JSR SYSRANX2 MEND MACRO&LAB FINDBUFF &ADR,&LEN AIF C:WR0>0,.XXWR0 EQU $C0WR1 EQU $C1WR2 EQU $C2WR3 EQU $C3.XX LCLC &IM&LAB LDA #&ADR STA WR0 LDA #>&ADR STA WR1&IM AMID &LEN,1,1 AIF "&IM"="#",.A LDA &LEN STA WR2 LDA &LEN+1 STA WR3 AGO .B.A&LEN AMID &LEN,2,L:&LEN LDA #&LEN STA WR2 LDA #>&LEN STA WR3.B JSR SYSFBUF MEND MACRO&LAB RESERVE &START,&LEN AIF C:WR0>0,.XXWR0 EQU $C0WR1 EQU $C1WR2 EQU $C2WR3 EQU $C3.XX LCLC &IM&IM AMID &START,1,1 AIF "&IM"="#",.A&LAB LDA &START STA WR0 LDA &START+1 STA WR1 AGO .B.A&START AMID &START,2,L:&START-1&LAB LDA #&START STA WR0 LDA #>&START STA WR1.B&IM AMID &LEN,1,1 AIF "&IM"="#",.C LDA &LEN STA WR2 LDA &LEN+1 STA WR3 AGO .D.C&LEN AMID &LEN,2,L:&LEN-1 LDA #&LEN STA WR2 LDA #>&LEN STA WR3.D JSR SYSRESV MEND MACRO&LAB ABSF &N1,&N2 AIF C:&N2>0,.A LCLC &N2.A&LAB FUOP &N1,&N2,SYSABSF MEND MACRO&LAB ADDF &N1,&N2,&N3 DC R'SYSSUBF' AIF C:&N3>0,.A LCLC &N3.A&LAB FBOP &N1,&N2,&N3,SYSADDF MEND MACRO&LAB DIVF &N1,&N2,&N3 AIF C:&N3>0,.A LCLC &N3.A&LAB FBOP &N1,&N2,&N3,SYSDIVF MEND MACRO&LAB MULF &N1,&N2,&N3 AIF C:&N3>0,.A LCLC &N3.A&LAB FBOP &N1,&N2,&N3,SYSMULF MEND MACRO&LAB RANF &N1 LCLC &C LCLC &C1 LCLC &B1 AIF '&N1'<>'*',.A&B1 SETC 011&C1 SETC ANOP AGO .E.A&C AMID &N1,1,1 AIF '&C'<>'{',.C&C AMID &N1,L:&N1,1 AIF '&C'<>'}',.K&N1 AMID &N1,2,L:&N1-2&B1 SETC 010 AGO .D.C&B1 SETC 001.D&C1 SETC 'DC I''&N1'''.E&LAB JSR SYSBOPR+12 DC A'SYSRANF' DC B'100 &B1' DS 1 &C1 DC R'SYSUNPF' DC R'SYSPAKF' MEXIT.K MNOTE 'Missing closing ''}''',16 MEND MACRO&LAB SIGNF &N1,&N2 AIF C:&N2>0,.A LCLC &N2.A&LAB FUOP &N1,&N2,SYSSGNF MEND MACRO&LAB SQRTF &N1,&N2 AIF C:&N2>0,.A LCLC &N2.A&LAB FUOP &N1,&N2,SYSSQRF MEND MACRO&LAB SUBF &N1,&N2,&N3 AIF C:&N3>0,.A LCLC &N3.A&LAB FBOP &N1,&N2,&N3,SYSSUBF MEND MACRO&LAB FUOP &N1,&N2,&SUB LCLC &C LCLC &C1 LCLC &C2 LCLC &B1 LCLC &B2 LCLB &ST1 AIF '&N1'<>'*',.A&B1 SETC 011&ST1 SETB 1&C1 SETC ANOP AGO .E.A&C AMID &N1,1,1 AIF '&C'<>'#',.B&B1 SETC 000&N1 AMID &N1,2,L:&N1-1&C1 SETC 'DC F''&N1''' AGO .E.B AIF '&C'<>'{',.C&C AMID &N1,L:&N1,1 AIF '&C'<>'}',.K&N1 AMID &N1,2,L:&N1-2&B1 SETC 010 AGO .D.C&B1 SETC 001.D&C1 SETC 'DC I''&N1'''.E AIF C:&N2>0,.F&B2 SETC &B1 AIF &ST1,.E1&C2 SETC 'DC I''&N1''' AGO .J.E1&C2 SETC ANOP AGO .J.F AIF '&N2'<>'*',.G&B2 SETC 011&C2 SETC ANOP AGO .J.G&C AMID &N2,1,1 AIF '&C'<>'{',.H&C AMID &N2,L:&N2,1 AIF '&C'<>'}',.K&N2 AMID &N2,2,L:&N2-2&B2 SETC 010 AGO .I.H&B2 SETC 001.I&C2 SETC 'DC I''&N2'''.J&LAB JSR SYSBOPR+8 DC A'&SUB' DC B'100 &B1 100 &B2' &C1 &C2 DC R'SYSUNPF' DC R'SYSPAKF' MEXIT.K MNOTE 'Missing closing ''}''',16 MEND MACRO&LAB FBOP &N1,&N2,&N3,&SUB LCLC &C LCLC &C1 LCLC &C2 LCLC &C3 LCLC &B1 LCLC &B2 LCLC &B3 LCLB &ST1 AIF '&N1'<>'*',.A&B1 SETC 011&ST1 SETB 1&C1 SETC ANOP AGO .E.A&C AMID &N1,1,1 AIF '&C'<>'#',.B&B1 SETC 000&N1 AMID &N1,2,L:&N1-1&C1 SETC 'DC F''&N1''' AGO .E.B AIF '&C'<>'{',.C&C AMID &N1,L:&N1,1 AIF '&C'<>'}',.P&N1 AMID &N1,2,L:&N1-2&B1 SETC 010 AGO .D.C&B1 SETC 001.D&C1 SETC 'DC I''&N1'''.E AIF '&N2'<>'*',.F&B2 SETC 011&C2 SETC ANOP AGO .J.F&C AMID &N2,1,1 AIF '&C'<>'#',.G&B2 SETC 000&N2 AMID &N2,2,L:&N2-1&C2 SETC 'DC F''&N2''' AGO .J.G AIF '&C'<>'{',.H&C AMID &N2,L:&N2,1 AIF '&C'<>'}',.P&N2 AMID &N2,2,L:&N2-2&B2 SETC 010 AGO .I.H&B2 SETC 001.I&C2 SETC 'DC I''&N2'''.J AIF C:&N3>0,.K&B3 SETC &B1 AIF &ST1,.J1&C3 SETC 'DC I''&N1''' AGO .O.J1&C3 SETC ANOP AGO .O.K AIF '&N3'<>'*',.L&B3 SETC 011&C3 SETC ANOP AGO .O.L&C AMID &N3,1,1 AIF '&C'<>'{',.M&C AMID &N3,L:&N3,1 AIF '&C'<>'}',.P&N3 AMID &N3,2,L:&N3-2&B3 SETC 010 AGO .N.M&B3 SETC 001.N&C3 SETC 'DC I''&N3'''.O&LAB JSR SYSBOPR DC A'&SUB' DC B'100 &B1 100 &B2 &B3' &C1 &C2 &C3 DC R'SYSUNPF' DC R'SYSPAKF' MEXIT.P MNOTE 'Missing closing ''}''',16 MEND MACRO&LAB CNVSF &N1,&N2 AIF C:&N2>0,.A LCLC &N2.A&LAB CNVSX &N1,&N2,111,100,C,SYSCFST,SYSGETF MEND MACRO&LAB PUTF &N1,&F1,&F2,&CR AIF C:&F1>0,.A LCLC &F1.A AIF C:&F2>0,.A1 LCLC &F2.A1 AIF C:&CR>0,.C LCLC &CR.C&LAB PUTR &N1,&F1,&F2,&CR,F,0100,F MEND MACRO&LAB PUTR &N1,&F1,&F2,&CR,&T,&BP,&DC LCLC &C LCLC &C1 LCLC &C2 LCLC &C3 LCLC &B1 LCLC &B2 LCLC &B3 AIF "&N1"<>"*",.A&B1 SETC 11&C1 SETC ANOP AGO .E.A&C AMID &N1,1,1 AIF "&C"<>"#",.B&B1 SETC 00&N1 AMID &N1,2,L:&N1-1&C1 SETC "DC &DC'&N1'" AGO .E.B AIF "&C"<>"{",.C&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.X&N1 AMID &N1,2,L:&N1-2&B1 SETC 10 AGO .D.C&B1 SETC 01.D&C1 SETC "DC I'&N1'".E AIF C:&F1>0,.F&B2 SETC 00&C2 SETC "DC I'0'" AGO .J.F AIF "&F1"<>"*",.G&B2 SETC 11&C2 SETC ANOP AGO .J.G&C AMID &F1,1,1 AIF "&C"<>"#",.G1&B2 SETC 00&F1 AMID &F1,2,L:&F1-1&C2 SETC "DC I'&F1'" AGO .J.G1 AIF "&C"<>"{",.H&C AMID &F1,L:&F1,1 AIF "&C"<>"}",.X&F1 AMID &F1,2,L:&F1-2&B2 SETC 10 AGO .I.H&B2 SETC 01.I&C2 SETC "DC I'&F1'".J AIF C:&F2>0,.K&B3 SETC 00&C3 SETC "DC I'0'" AGO .P.K AIF "&F2"<>"*",.L&B3 SETC 11&C3 SETC ANOP AGO .P.L&C AMID &F2,1,1 AIF "&C"<>"#",.M&B3 SETC 00&F2 AMID &F2,2,L:&F2-1&C3 SETC "DC I'&F2'" AGO .P.M AIF "&C"<>"{",.N&C AMID &F2,L:&F2,1 AIF "&C"<>"}",.X&F2 AMID &F2,2,L:&F2-2&B3 SETC 10 AGO .O.N&B3 SETC 01.O&C3 SETC "DC I'&F2'".P&LAB JSR SYSRITE DC A"SYSPUT&T"&C SETC 00 AIF C:&CR=0,.Q&C SETC 01.Q DC B"&BP &C &B1" DC B"&B2 &B3 0000" &C1 &C2 &C3 MEXIT.X MNOTE "Missing closing '}'",16 MEND MACRO&LAB CNVSX &N1,&N2,&BT1,&BT2,&DC,&SUB1,&SUB2 LCLC &C LCLC &C1 LCLC &C2 LCLC &B1 LCLC &B2 LCLB &ST1 AIF "&N1"<>"*",.A&B1 SETC 011&ST1 SETB 1&C1 SETC ANOP AGO .E.A&C AMID &N1,1,1 AIF "&C"<>"#",.B&B1 SETC 000&N1 AMID &N1,2,L:&N1-1 AIF "&DC"="C",.A1&C1 SETC "DC &DC'&N1'" AGO .E.A1&C1 SETC "DC C&N1" AGO .E.B AIF "&C"<>"{",.C&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.K&N1 AMID &N1,2,L:&N1-2&B1 SETC 010 AGO .D.C&B1 SETC 001.D&C1 SETC "DC I'&N1'".E AIF C:&N2>0,.F&B2 SETC &B1 AIF &ST1,.E1&C2 SETC "DC I'&N1'" AGO .J.E1&C2 SETC ANOP AGO .J.F AIF "&N2"<>"*",.G&B2 SETC 011&C2 SETC ANOP AGO .J.G&C AMID &N2,1,1 AIF "&C"<>"{",.H&C AMID &N2,L:&N2,1 AIF "&C"<>"}",.K&N2 AMID &N2,2,L:&N2-2&B2 SETC 010 AGO .I.H&B2 SETC 001.I&C2 SETC "DC I'&N2'".J&LAB JSR &SUB1 DC A"&SUB2" DC B"&BT1 &B1 &BT2 &B2" &C1 &C2 MEXIT.K MNOTE "Missing closing '}'",16 MEND MACRO&LAB EXPF &N1,&N2 AIF C:&N2>0,.A LCLC &N2.A&LAB FUOP &N1,&N2,SYSEXPF MEND MACRO&LAB INTF &N1,&N2 AIF C:&N2>0,.A LCLC &N2.A&LAB FUOP &N1,&N2,SYSINTF MEND MACRO&LAB LNF &N1,&N2 AIF C:&N2>0,.A LCLC &N2.A&LAB FUOP &N1,&N2,SYSLNXF MEND MACRO&LAB PWRF &N1,&N2,&N3 AIF C:&N3>0,.A LCLC &N3.A&LAB FBOP &N1,&N2,&N3,SYSPWRF MEND MACRO&LAB ATANF &N1,&N2 AIF C:&N2>0,.A LCLC &N2.A&LAB FUOP &N1,&N2,SYSATNF MEND MACRO&LAB COSF &N1,&N2 AIF C:&N2>0,.A LCLC &N2.A&LAB FUOP &N1,&N2,SYSCOSF MEND MACRO&LAB SINF &N1,&N2 DC R'SYSCOSF' AIF C:&N2>0,.A LCLC &N2.A&LAB FUOP &N1,&N2,SYSSINF MEND MACRO&LAB TANF &N1,&N2 AIF C:&N2>0,.A LCLC &N2.A&LAB FUOP &N1,&N2,SYSTANF MEND